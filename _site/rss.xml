<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Richard Jones</title>
    <description>Logbook / blog / devlog</description>
    <link>http://0.0.0.0:4000/</link>
    <atom:link href="http://0.0.0.0:4000/feed.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Mon, 09 Dec 2024 05:59:28 -0600</pubDate>
    <lastBuildDate>Mon, 09 Dec 2024 05:59:28 -0600</lastBuildDate>
    <generator>Jekyll v4.2.2</generator>
    
      <item>
        <title>Bevygap: Autoscaling multiplayer Bevy game servers with Edgegap &amp;amp; Lightyear</title>
        <description>&lt;p&gt;If i‚Äôm going to write a server-authoritative multiplayer game, it would be nice to have a decent way to deploy it. Especially to deploy servers around the world in response to player demand, to autoscale and keep latency down.&lt;/p&gt;

&lt;h4 id=&quot;modifying-the-lightyear-spaceships-example&quot;&gt;Modifying the Lightyear spaceships example&lt;/h4&gt;

&lt;p&gt;&lt;img align=&quot;right&quot; width=&quot;100&quot; src=&quot;/assets/images/bevy/bevy-logo.png&quot; /&gt;&lt;/p&gt;

&lt;p&gt;I took my &lt;a href=&quot;https://github.com/cBournhonesque/lightyear/tree/main/examples/spaceships&quot;&gt;spaceships example&lt;/a&gt; from the &lt;a href=&quot;https://github.com/cBournhonesque/lightyear&quot;&gt;lightyear repo&lt;/a&gt;, and repackaged it with the following changes:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Split into a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;client&lt;/code&gt;, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;shared&lt;/code&gt;, and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;server&lt;/code&gt; crates&lt;/li&gt;
  &lt;li&gt;Changed to only support webtransport ‚Äì no steam, no plain UDP, etc.&lt;/li&gt;
  &lt;li&gt;Made server headless - no gui option&lt;/li&gt;
  &lt;li&gt;Added Dockerfile to build the server; produces a ~30mb image (thanks &lt;a href=&quot;https://github.com/GoogleContainerTools/distroless&quot;&gt;distroless&lt;/a&gt;)&lt;/li&gt;
  &lt;li&gt;Added Dockerfile to build wasm client; produces an image based on &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;nginx&lt;/code&gt; to serve our &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;index.html&lt;/code&gt; and wasm assets.&lt;/li&gt;
  &lt;li&gt;Added Github actions to build and push the server and wasm client docker images&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;At this point it was easy enough to run the server and client containers on a single server, and I started to look for a way to autodeploy servers to multiple locations on demand. I‚Äôm not going to review the various options or discuss the pros and cons other than to say there are a few to choose from, and I decided to go with &lt;a href=&quot;https://edgegap.com&quot;&gt;Edgegap&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;My &lt;a href=&quot;https://github.com/RJ/bevygap-spaceships&quot;&gt;bevygap-spaceships&lt;/a&gt; repo contains this repackaged version of the spaceships demo.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/bevy/spaceships.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;edgegap--the-basics&quot;&gt;Edgegap ‚Äì the basics&lt;/h3&gt;

&lt;p&gt;&lt;img align=&quot;right&quot; width=&quot;150&quot; src=&quot;/assets/images/bevy/edgegap-logo.png&quot; /&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;You push the gameserver docker image to Edgegap‚Äôs container registry, so they are able to deploy gameservers for you at will.&lt;/li&gt;
  &lt;li&gt;You configure the metadata for your game ‚Äì max players per server, time an empty server stays online for, etc.&lt;/li&gt;
  &lt;li&gt;When players want to play, you use Edgegap‚Äôs API to create a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Session&lt;/code&gt;, which is a list of at least 1 player IP addresses.&lt;/li&gt;
  &lt;li&gt;For every &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Session&lt;/code&gt;, Edgegap will either return the details for an already-running server, that has capacity, in a sensible location, for the IPs in the session, or take a few seconds to deploy another gameserver for you, before returning the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;deployment&lt;/code&gt; details. An edgegap &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;deployment&lt;/code&gt; refers to a single instance of your gameserver container, and includes amongst other things the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ip:port&lt;/code&gt; clients need to make a connection&lt;/li&gt;
  &lt;li&gt;You pass the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ip:port&lt;/code&gt; along to the game client, which makes the connection to the server.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There‚Äôs a bit of plumbing needed to wire all this up so it‚Äôs easy to use in bevy, which I will now explain.&lt;/p&gt;

&lt;h2 id=&quot;bevygap-a-toolkit-for-running-serverclient-games-on-edgegap&quot;&gt;Bevygap: a toolkit for running server/client games on Edgegap&lt;/h2&gt;

&lt;p&gt;Allow me to introduce the various components:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/bevy/bevygap-20241105.png&quot; alt=&quot;Bevygap component diagram&quot; /&gt;&lt;/p&gt;

&lt;h4 id=&quot;messaging-layer&quot;&gt;Messaging layer&lt;/h4&gt;

&lt;p&gt;&lt;a href=&quot;nats.io&quot;&gt;
&lt;img align=&quot;right&quot; width=&quot;150&quot; src=&quot;/assets/images/bevy/nats-logo.png&quot; /&gt;
&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;small&gt;NATS, running from a docker container, listening using TLS&lt;/small&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Gameservers need to be able to talk to the matchmaker(s), and a bit of key/value storage is useful for configuration. I chose to use NATS, which supports various messaging patterns like pub-sub, along with some key/value storage. My NATS server listens on a public IP, so that the gameservers can connect to it from Edgegap‚Äôs infrastructure.&lt;/p&gt;

&lt;h4 id=&quot;matchmaker&quot;&gt;Matchmaker&lt;/h4&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;small&gt;A rust async tokio binary&lt;/small&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;When a player wants to connect, the matchmaker talks to the edgegap API to create a session, and await the results before returning the deployment details (the gameserver &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ip:port&lt;/code&gt; etc). The matchmaker exposes this functionality as a service on the NATS bus.&lt;/p&gt;

&lt;h4 id=&quot;matchmaker-httpd&quot;&gt;Matchmaker HTTPd&lt;/h4&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;small&gt;A rust async tokio binary using the Axum webserver&lt;/small&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is the public websocket interface to the matchmaker. It speaks JSON to the game clients, and passes on the query via NATS to the matchmaker service.&lt;/p&gt;

&lt;h4 id=&quot;bevygap-server-plugin&quot;&gt;Bevygap Server Plugin&lt;/h4&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;small&gt;A bevy plugin for the gameserver&lt;/small&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;At startup, this will make a connection to your NATS server, and read the various environment variables set by Edgegap. This tells us things like the geographic location of the server, the public &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ip:port&lt;/code&gt;, and how to fetch additional context data. Check out the &lt;a href=&quot;https://docs.edgegap.com/docs/deployment/injected-variables&quot;&gt;edgegap docs for injected variables&lt;/a&gt; for more.&lt;/p&gt;

&lt;h4 id=&quot;bevygap-client-plugin&quot;&gt;Bevygap Client Plugin&lt;/h4&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;small&gt;A bevy plugin for the game client, wasm and native&lt;/small&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is mostly concerned with connecting to our matchmaker websocket over http, and requesting to play. Once a successful response is returned, the plugin will modify the Lightyear settings with the returned server ip and port, the lightyear &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ConnectToken&lt;/code&gt;, and in the case of wasm clients, the certificate digest for the WebTransport connection. It then signals the game to make the connection to the lightyear game server.&lt;/p&gt;

&lt;p&gt;As part of this, I wrote &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bevy_nfws&lt;/code&gt;, a &lt;strong&gt;n&lt;/strong&gt;o-&lt;strong&gt;f&lt;/strong&gt;rills &lt;strong&gt;w&lt;/strong&gt;eb&lt;strong&gt;s&lt;/strong&gt;ocket client library for bevy that works on native and wasm. There are a few feature-rich websocket libraries for bevy already, but many expect you to also be running bevy on the server end of the connection, which I‚Äôm not.&lt;/p&gt;

&lt;h2 id=&quot;modifying-a-lightyear-game-to-use-bevygap&quot;&gt;Modifying a Lightyear game to use bevygap&lt;/h2&gt;

&lt;p&gt;Code changes to the server and client are minimal. My example game toggles them with a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bevygap&lt;/code&gt; cargo feature, so I can still do local development without using the matchmaker.&lt;/p&gt;

&lt;h4 id=&quot;server&quot;&gt;Server&lt;/h4&gt;

&lt;p&gt;Your lightyear gameserver needs two changes to support bevygap: adding the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BevygapServerPlugin&lt;/code&gt;, and delaying listening on the socket until bevygap reports it is ready. Any failure to connect to NATS or read the edgegap ENVs during startup will cause a panic by design.&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Plugin&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BevygapSpaceshipsServerPlugin&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;App&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// Add the bevygap server plugin which will connect to NATS, read the environment, etc&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.add_plugins&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;BevygapServerPlugin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;self_signed_digest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cert_digest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// only start listening once bevygap setup complete&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.observe&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start_listening_once_bevygap_ready&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;cd&quot;&gt;/// Without bevygap, you&apos;d just call `start_server()` in a Startup system.&lt;/span&gt;
&lt;span class=&quot;cd&quot;&gt;/// We defer this until bevygap setup is complete.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;start_listening_once_bevygap_ready&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Trigger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BevygapReady&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nd&quot;&gt;info!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Lightyear server listening, bevygap reported ready&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.start_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h5 id=&quot;webtransport-wasm-clients-and-tls-certificate-digests&quot;&gt;WebTransport, WASM Clients, and TLS Certificate Digests&lt;/h5&gt;

&lt;p&gt;My gameserver &lt;a href=&quot;https://github.com/RJ/bevygap-spaceships/blob/9583777aa2f6e01a6b28428b7ba92be428fc084a/server/src/main.rs#L74&quot;&gt;generates&lt;/a&gt; a WebTransport-specification-&lt;a href=&quot;https://w3c.github.io/webtransport/#dom-webtransportoptions-servercertificatehashes&quot;&gt;compliant&lt;/a&gt; self-signed TLS cert on startup.
This is fully supported as long as you provide the certificate digest to the browser before it attempts a connection, and comply with the &lt;a href=&quot;https://w3c.github.io/webtransport/#verify-a-certificate-hash&quot;&gt;following part&lt;/a&gt; of the spec:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;The certificate MUST be an X.509v3 certificate as defined in RFC5280.&lt;/li&gt;
  &lt;li&gt;The key used in the Subject Public Key field MUST be one of the allowed public key algorithms. (I‚Äôm using ECDSA P-256)&lt;/li&gt;
  &lt;li&gt;The current time MUST be within the validity period of the certificate as defined in Section 4.1.2.5 of RFC5280.&lt;/li&gt;
  &lt;li&gt;The total length of the validity period MUST NOT exceed two weeks.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The bevygap system automatically stores the certificate digest in NATS and passes it along to clients in the matchmaker response.&lt;/p&gt;

&lt;h4 id=&quot;client&quot;&gt;Client&lt;/h4&gt;

&lt;p&gt;Add the bevygap client plugin, after inserting &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BevygapClientConfig&lt;/code&gt;, specifying:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;the URL to the matchmaker websocket, eg: &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wss://matchmaker.example.com/matchmaker/ws&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;the name of the game, as configured in edgegap&lt;/li&gt;
  &lt;li&gt;the version of the game, as configured in edgegap&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Instead of calling Lightyear‚Äôs &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;commands.connect_client()&lt;/code&gt;, you use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;commands.bevygap_connect_client()&lt;/code&gt; which will call lightyear‚Äôs &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;connect_client()&lt;/code&gt; for you after receiving a response from the matchmaker and modifying the connection parameters.&lt;/p&gt;

&lt;p&gt;You can watch for changes to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BevygapClientState&lt;/code&gt; to see progress.&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;impl&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Plugin&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;BevygapSpaceshipsClientPlugin&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;build&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;App&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// ..&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.insert_resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BevygapClientConfig&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;n&quot;&gt;matchmaker_url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;get_matchmaker_url&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
          &lt;span class=&quot;n&quot;&gt;game_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;bevygap-spaceships&quot;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
          &lt;span class=&quot;n&quot;&gt;game_version&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.to_string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt;
          &lt;span class=&quot;o&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;

      &lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.add_plugins&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;BevygapClientPlugin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;app&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.add_systems&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Startup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

      &lt;span class=&quot;c1&quot;&gt;// You can monitor changes to matchmaking state like this:&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// app.add_systems(&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;//     Update,&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;//     on_bevygap_state_change.run_if(state_changed::&amp;lt;BevygapClientState&amp;gt;),&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// );&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// ..&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;cd&quot;&gt;/// This opens the websocket to the matchmaker url, and requests to play.&lt;/span&gt;
&lt;span class=&quot;cd&quot;&gt;/// Once a successful response arrives, it calls lightyear&apos;s commands.connect_client() fn.&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;fn&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;connect&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;mut&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Commands&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;commands&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.bevygap_connect_client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;cost-and-scaling&quot;&gt;Cost and Scaling&lt;/h2&gt;

&lt;p&gt;If you follow the Edgegap setup instructions in &lt;a href=&quot;https://rj.github.io/bevygap/installation/edgegap.html&quot;&gt;The Bevygap Book&lt;/a&gt; you‚Äôll see that I set the ‚ÄúEmpty Time To Live‚Äù to 10 minutes, and select autodeploy. This means server instances are terminated after 10 mins of having no connected players, and automatically started where they are needed.&lt;/p&gt;

&lt;p&gt;Since Edgegap charge for the running time and bandwidth servers use, you aren‚Äôt billed for the time you have zero instances running.&lt;/p&gt;

&lt;p&gt;This means as well as scaling up, it scales down to almost zero when there are no players. There is a small fixed cost for a low powered server that runs NATS and the matchmaker service. I run those services on the machine that hosts this website.&lt;/p&gt;

&lt;h2 id=&quot;using-it&quot;&gt;Using it&lt;/h2&gt;

&lt;p&gt;You can set this all up with an Edgegap free trial account. The installation sections in &lt;a href=&quot;https://rj.github.io/bevygap/&quot;&gt;The Bevygap Book&lt;/a&gt; shows how I set up NATS (and the &lt;a href=&quot;https://docs.nats.io/&quot;&gt;offical NATS docs&lt;/a&gt; are excellent), along with Edgegap, and all the required environment variables.&lt;/p&gt;

&lt;p&gt;If you try it out, let me know in the &lt;a href=&quot;https://discord.com/channels/691052431525675048/1189344685546811564&quot;&gt;#lightyear channel&lt;/a&gt; on Bevy‚Äôs Discord.&lt;/p&gt;

&lt;h1 id=&quot;live-demo&quot;&gt;Live Demo&lt;/h1&gt;

&lt;p&gt;Is the &lt;a href=&quot;https://game.metabrew.com/bevygap-spaceships/&quot;&gt;live demo of bevygap-spaceships&lt;/a&gt; working? Hopefully! In chrome at least..&lt;/p&gt;

&lt;h3 id=&quot;links&quot;&gt;Links&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://bevyengine.org/&quot;&gt;Bevy&lt;/a&gt; - A refreshingly simple data-driven game engine built in Rust&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/cBournhonesque/lightyear&quot;&gt;Lightyear&lt;/a&gt; - A networking library to make multiplayer games for the Bevy game engine&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/RJ/bevygap-spaceships&quot;&gt;bevygap-spaceships&lt;/a&gt; game repo, my split server/client version of Lightyear‚Äôs spaceships example, with bevygap support.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/RJ/bevygap&quot;&gt;Bevygap&lt;/a&gt; repo, the toolkit for making all this work&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://rj.github.io/bevygap/installation/edgegap.html&quot;&gt;The Bevygap Book&lt;/a&gt; - docs for setting up bevygap and related bits&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://edgegap.com&quot;&gt;Edgegap&lt;/a&gt; - this does the deployment and session management of our gameserver&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://nats.io&quot;&gt;NATS&lt;/a&gt; - Message bus ++&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://game.metabrew.com/bevygap-spaceships/&quot;&gt;Live demo of spaceships example game&lt;/a&gt; - use a Chrome based browser&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;See my &lt;a href=&quot;/tag/bevygap&quot;&gt;other posts tagged as ‚Äòbevygap‚Äô&lt;/a&gt;.&lt;/p&gt;
</description>
        <pubDate>Mon, 09 Dec 2024 00:00:00 -0600</pubDate>
        <link>http://0.0.0.0:4000/article/bevygap-bevy-multiplayer-with-edgegap-and-lightyear</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/article/bevygap-bevy-multiplayer-with-edgegap-and-lightyear</guid>
        
        <category>gamedev</category>
        
        <category>rust</category>
        
        <category>edgegap</category>
        
        <category>netcode</category>
        
        <category>multiplayer</category>
        
        <category>bevy</category>
        
        <category>bevygap</category>
        
        
      </item>
    
      <item>
        <title>Rock and Rollback: Realtime multiplayer in the browser, with rust and bevy</title>
        <description>&lt;p&gt;How hard it is to build a realtime multiplayer browser game? Like asteroids, but multiplayer. Retro vibes with modern netcode üöÄ.&lt;/p&gt;

&lt;h3 id=&quot;realtime-multiplayer-in-the-browser&quot;&gt;Realtime multiplayer in the browser&lt;/h3&gt;

&lt;p&gt;Until relatively recently, realtime multiplayer in the browser was hamstrung by the lack of an unreliable network transport. Everything the browser did was TCP, and &lt;em&gt;the&lt;/em&gt; realtime option was websockets.&lt;/p&gt;

&lt;p&gt;TCP has head-of-line blocking though, because it‚Äôs a reliable ordered stream. If you‚Äôre streaming positional updates 60 times a second, and one of those packets is dropped or delayed, TCP won‚Äôt deliver any newly arrived packets to your game until the dropped one is retransmitted, effectively delaying all subsequent packets too. That‚Äôs why realtime netcode prefers UDP.&lt;/p&gt;

&lt;p&gt;With UDP it‚Äôs up to your game protocol to handle dropped packets, which is extra work, but means you can stream realtime data and not suffer the same issues as TCP. Packets are delivered to your game as soon as they arrive, regardless of any packet loss or delays.&lt;/p&gt;

&lt;p&gt;If only there was a way to do this in the browser..&lt;/p&gt;

&lt;h4 id=&quot;browser-technologies-for-unreliable-datagrams&quot;&gt;Browser technologies for unreliable datagrams&lt;/h4&gt;

&lt;p&gt;&lt;strong&gt;WebRTC&lt;/strong&gt;, which is designed for video and audio calling in the browser, has an Unreliable Datachannel option (UDP). This is suitable, but there is quite a lot of machinery required to present yourself as a WebRTC server just to open a data channel.&lt;/p&gt;

&lt;p&gt;The newish &lt;strong&gt;WebTransport&lt;/strong&gt; API operates over &lt;a href=&quot;https://en.wikipedia.org/wiki/HTTP/3&quot;&gt;HTTP/3&lt;/a&gt;, using QUIC ‚Äì atop UDP. It supports unreliable data channels, and is less of a headache to use serverside. Nowadays this seems like a decent choice for the in-browser network layer for a realtime game.&lt;/p&gt;

&lt;h2 id=&quot;choosing-a-network-model-abridged&quot;&gt;Choosing a network model, abridged&lt;/h2&gt;

&lt;p&gt;To figure out how to network multiplayer asteroids, it behooves us to consider one of the most common approaches to netcode called &lt;strong&gt;Snapshot Interpolation&lt;/strong&gt; ‚Äì used by first person shooters for decades.&lt;/p&gt;

&lt;h3 id=&quot;quake-et-al&quot;&gt;Quake, et al.&lt;/h3&gt;

&lt;p&gt;Quake, and many FPS games that came after it, can be described as:&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;A bunch of players moving around a mostly static world, shooting at each other.&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;These games are continually sending your inputs (move forward, jump, shoot..) to the server. The server is simulating your character, along with the rest of the players, as inputs arrive. The server streams snapshots back to you containing up-to-date positions at specific points in time (each ‚Äútick‚Äù).&lt;/p&gt;

&lt;p&gt;To smooth out the movement, the game buffers incoming snapshots and interpolates between two recent ones to compute player positions. This gives silky smooth movement, but results in you seeing a slightly outdated position for other players.&lt;/p&gt;

&lt;p&gt;This is the standard approach for competetive FPS. You can tune the buffers to smooth over network lag spikes, at the cost of moving remote player timelines further into the past.&lt;/p&gt;

&lt;h4 id=&quot;local-player-prediction-and-rollback&quot;&gt;Local-player Prediction and Rollback&lt;/h4&gt;

&lt;p&gt;To further complicate matters, when you hit &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;W&lt;/code&gt; to move forward, the game doesn‚Äôt wait for a server update before moving your own player‚Äôs position. &lt;strong&gt;Your own position is predicted, not interpolated&lt;/strong&gt;, ie. when you press forward, your local player immediately moves forward, while your &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;I&apos;m pressing W on tick 123&lt;/code&gt; packet travels to the server. The server processes it, dutifully moves your player forward, and includes the new position in the next snapshot.&lt;/p&gt;

&lt;p&gt;Your game client, which kept a record of your predicted movement and inputs for the last few ticks, will need to reconcile this with updates received from the server. If the snapshot position at a given tick matches the position in your buffer at that tick, that‚Äôs ideal. If there was a misprediction, you wind back your position to the tick from the snapshot, snap your player to the snapshot-position, and replay any stored input commands to fast-forward your predicted location back to your current predicted tick on the client.&lt;/p&gt;

&lt;h3 id=&quot;snapshot-interpolation-asteroids&quot;&gt;Snapshot interpolation asteroids?&lt;/h3&gt;

&lt;p&gt;What happens if we apply this model to multiplayer asteroids? We predict movement of your own ship, just like FPS, and do snapshot interpolation for remote players and asteroids.&lt;/p&gt;

&lt;p&gt;The movement of players and asteroids would be nice and smooth, right up to the moment you collide with something.&lt;/p&gt;

&lt;p&gt;Your ship is locally predicted ahead of the server, based on your inputs. Remote asteroids or players are shown in the past, due to snapshot interpolation. So you‚Äôre essentially seeing the position of other objects but from (say) 75ms in the past.&lt;/p&gt;

&lt;p&gt;For a game that would surely involve lots of crashing into other players and asteroids, we don‚Äôt want janky collisions.&lt;/p&gt;

&lt;h2 id=&quot;client-prediction--rollback-for-everything&quot;&gt;Client Prediction &amp;amp; Rollback for Everything&lt;/h2&gt;

&lt;p&gt;Asteroids are pretty simple, they just keep moving until they collide with something. So we‚Äôll have our client project their position forward into the same timeline as the local player. This means we run same physics simulation code on the client as we do on the server.&lt;/p&gt;

&lt;p&gt;We‚Äôll store a historical record for each entity: the last few frames of position/rotation. When we get a server update about a position, we can check it against our historical record for that tick. If there were any discrepencies, we perform a rollback: wind back time to the tick from the server update, snap positions to the server-authoritative position, and fast-forward back to our current tick, resimulating the physics as we go ‚Äì and in the case of mispredicted players, re-applying any stored inputs.&lt;/p&gt;

&lt;p&gt;Any errors corrected after rollback, as a result of a misprediction, can be blended in visually over a few frames. Meanwhile the underlying state of the client‚Äôs physics always strives to be as correct as possible.&lt;/p&gt;

&lt;h2 id=&quot;experiments-with-bevy&quot;&gt;Experiments with Bevy&lt;/h2&gt;

&lt;p&gt;I did some experiments with the bevy game engine and a home-grown netcode/rollback system to explore what would work for multiplayer asteroids.&lt;/p&gt;

&lt;h4 id=&quot;client-prediction-single-player&quot;&gt;Client-prediction, single player&lt;/h4&gt;

&lt;p&gt;This experiment, with just one player connected to the server, predicts the position of asteroids into the same timeframe as the player. The grey outlines show the most recent position of the object received from the server. The server tick rate is set fairly low so it‚Äôs easy to see what‚Äôs happening. There were no mispredictions, because with just one player connected, everything is deterministic.&lt;/p&gt;

&lt;figure&gt;
    &lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/ZAbuYm6MS5s?si=qmnr3lyuJ0E-UWLh&quot; title=&quot;YouTube video player&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot; allowfullscreen=&quot;&quot;&gt;&lt;/iframe&gt;

    
    &lt;figcaption class=&quot;caption-text&quot;&gt;Client on the left, server on the right. 100ms simulated lag. No Audio.&lt;/figcaption&gt;
    
&lt;/figure&gt;

&lt;p&gt;If you fullscreen this video, you‚Äôll be able to see the light grey outline of each entity - that is the last received authoritative server position. The colored outlines are where the client has predicted them in the client timeline. No rollbacks or jank because with a single player, there aren‚Äôt any mispredictions.&lt;/p&gt;

&lt;h4 id=&quot;timeline-jank-experiment&quot;&gt;Timeline jank experiment&lt;/h4&gt;

&lt;p&gt;Here‚Äôs an experiment I conducted testing how collisions behave differently when asteroids are predicted forward into the same timeline as the local player.&lt;/p&gt;

&lt;p&gt;Movement looks good in isolation, however per my voiceover in the next video, remote players do get janky collisions.
This is because of the temporal disrepency between remote players and other objects. With remote players
held 6 frames in the past, which equates to around 100ms, there are janky collisions. Watch what happens to collisions when I enable input prediction for remote players, to bring them into the same timeframe as the local player and asteroids:&lt;/p&gt;

&lt;figure&gt;
    &lt;iframe width=&quot;560&quot; height=&quot;315&quot; src=&quot;https://www.youtube.com/embed/Jxetoat3wsw?si=xdB4BAlE2hz27Ugh&quot; title=&quot;YouTube video player&quot; frameborder=&quot;0&quot; allow=&quot;accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share&quot; allowfullscreen=&quot;&quot;&gt;&lt;/iframe&gt;

    
    &lt;figcaption class=&quot;caption-text&quot;&gt;Audio commentary ‚Äì unmute! Each player has 70ms of simulated lag.&lt;/figcaption&gt;
    
&lt;/figure&gt;

&lt;h2 id=&quot;predicting-remote-players&quot;&gt;Predicting Remote Players&lt;/h2&gt;

&lt;p&gt;Since we don‚Äôt have up-to-date inputs for remote players on our most recent ticks, we just assume they are still pressing the same buttons as the last-known input.
Players holding down forward are most likely to still be holding down forward.&lt;/p&gt;

&lt;p&gt;This, plus smearing errors due to mispredictions over a couple of frames, can work pretty well, provided we keep player latency to a reasonable amount.&lt;/p&gt;

&lt;p&gt;We can also bake in 3 ticks of input delay for all players. So inputs a client presses are used for t+3, but sent to the server immediately and rebroadcast to other players. This means sometimes you do in fact have all inputs for remote players, or at least only have to guess 1 or 2 ticks worth.&lt;/p&gt;

&lt;h2 id=&quot;implementation-details&quot;&gt;Implementation Details&lt;/h2&gt;

&lt;p&gt;These experiments really helped me understand what kind of netcode model I needed ‚Äì but I ended up throwing away most of the code I‚Äôd written. My rollback implementation was kind of a mess, being very new to rust, bevy, and gamedev in general. I was very happy to discover &lt;a href=&quot;https://github.com/cBournhonesque/lightyear&quot;&gt;Lightyear&lt;/a&gt;, which has built-in prediction &amp;amp; rollback, and WebTransport support that works on native and WASM builds.&lt;/p&gt;

&lt;p&gt;I contributed a basic asteroid-esque game to the Lightyear examples, called &lt;a href=&quot;https://github.com/cBournhonesque/lightyear/tree/main/examples/spaceships&quot;&gt;spaceships&lt;/a&gt;, which allowed me to experiment with how things like predicted bullet spawning should work.  The spaceships demo does client prediction for players and ‚Äúasteroids‚Äù (well, circles). It compiles to wasm and works in Chrome (as of this post, I think it works in firefox nightly but not stable yet):&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/bevy/spaceships.png&quot; alt=&quot;Spaceships screenshot&quot; /&gt;&lt;/p&gt;

&lt;figure&gt;
    &lt;img src=&quot;/assets/images/spaceships.png&quot; alt=&quot;Spaceships example game from Lightyear&quot; /&gt;
    
        &lt;figcaption class=&quot;caption-text&quot;&gt;WASM on the left, native app on the right&lt;/figcaption&gt; 
    
&lt;/figure&gt;

&lt;h2 id=&quot;onwards&quot;&gt;Onwards&lt;/h2&gt;

&lt;p&gt;Time to build a game! But wait, let‚Äôs procrastinate a little more first by trying to figure out a good way to deploy multiplayer bevy games that use lightyear..&lt;/p&gt;

&lt;h4 id=&quot;links&quot;&gt;Links&lt;/h4&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=ueEmiDM94IE&quot;&gt;It IS Rocket Science! The Physics of Rocket League Detailed&lt;/a&gt; a great GDC talk. Rocket League uses a similar network model.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://mas-bandwidth.com/choosing-the-right-network-model-for-your-multiplayer-game/&quot;&gt;Choosing the right network model for your multiplayer game&lt;/a&gt; by Glenn Fiedler. All his articles about game networking are essential reading.&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://bevyengine.org/&quot;&gt;Bevy&lt;/a&gt; - A refreshingly simple data-driven game engine built in Rust&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/cBournhonesque/lightyear&quot;&gt;Lightyear&lt;/a&gt; - A fantastic networking library to make multiplayer games for the Bevy game engine&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;See my &lt;a href=&quot;/tag/bevygap&quot;&gt;other posts tagged as ‚Äòbevygap‚Äô&lt;/a&gt;.&lt;/p&gt;
</description>
        <pubDate>Sun, 08 Dec 2024 00:00:00 -0600</pubDate>
        <link>http://0.0.0.0:4000/article/rock-and-rollback-realtime-multiplayer-games-with-bevy</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/article/rock-and-rollback-realtime-multiplayer-games-with-bevy</guid>
        
        <category>gamedev</category>
        
        <category>netcode</category>
        
        <category>multiplayer</category>
        
        <category>bevy</category>
        
        <category>bevygap</category>
        
        
      </item>
    
      <item>
        <title>10 years later&amp;hellip;</title>
        <description>&lt;p&gt;I have dragged my blog, kicking and screaming, into the era of media-queries and responsive CSS. So now it‚Äôs readable on a variety of screen sizes. My first post was roughly the same year the iPhone 3G came out I think, and the mobile web wasn‚Äôt really a big deal back then.&lt;/p&gt;

&lt;p&gt;I imported ancient Disqus comments into github issue comments, and am giving &lt;a href=&quot;https://utteranc.es/&quot;&gt;Utterances&lt;/a&gt; a try for comments, since it was the least hassle to set up.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;In my limited free time, I am learning Rust ‚Äì specifically because I want to target WASM to build a simple multiplayer game that runs in the browser. Using UDP, via WebRTC hacks. With excellent rollback-netcode for responsive competitive play.. So not really that simple I guess ü§∑üèº‚Äç‚ôÇÔ∏è.&lt;/p&gt;

&lt;blockquote class=&quot;twitter-tweet&quot;&gt;&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;Bit of exploratory &lt;a href=&quot;https://twitter.com/hashtag/rustlang?src=hash&amp;amp;ref_src=twsrc%5Etfw&quot;&gt;#rustlang&lt;/a&gt; &lt;a href=&quot;https://twitter.com/hashtag/gamedev?src=hash&amp;amp;ref_src=twsrc%5Etfw&quot;&gt;#gamedev&lt;/a&gt; fun. Using &lt;a href=&quot;https://twitter.com/BevyEngine?ref_src=twsrc%5Etfw&quot;&gt;@BevyEngine&lt;/a&gt; with &lt;a href=&quot;https://twitter.com/dimforge?ref_src=twsrc%5Etfw&quot;&gt;@dimforge&lt;/a&gt;&amp;#39;s Rapier physics engine, and bevy_prototype_lyon to render. Compiles to webassembly too, which is neat. &lt;a href=&quot;https://t.co/Kge8CtgGar&quot;&gt;pic.twitter.com/Kge8CtgGar&lt;/a&gt;&lt;/p&gt;&amp;mdash; Richard Jones (RJ) (@metabrew) &lt;a href=&quot;https://twitter.com/metabrew/status/1399356281446711298?ref_src=twsrc%5Etfw&quot;&gt;May 31, 2021&lt;/a&gt;&lt;/blockquote&gt;
&lt;script async=&quot;&quot; src=&quot;https://platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;

</description>
        <pubDate>Thu, 29 Jul 2021 00:00:00 -0500</pubDate>
        <link>http://0.0.0.0:4000/article/2021-blog-update</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/article/2021-blog-update</guid>
        
        <category>life</category>
        
        
      </item>
    
      <item>
        <title>BigWig: A better Erlang webtool (spawnfest entry)</title>
        <description>&lt;p&gt;This weekend, &lt;a href=&quot;http://twitter.com/mokele&quot;&gt;Steve&lt;/a&gt;, &lt;a href=&quot;http://twitter.com/skarab&quot;&gt;Hunter&lt;/a&gt;, &lt;a href=&quot;http://twitter.com/puzza007&quot;&gt;Paul&lt;/a&gt; and I took part in &lt;a target=&quot;new&quot; href=&quot;http://spawnfest.com/&quot;&gt;Spawnfest&lt;/a&gt;, a 48-hour Erlang programming
event.&lt;/p&gt;

&lt;p&gt;Our team name was SMELLS LIKE BEAM SPIRIT. Here we are on Sunday evening:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/images/bigwig/team.jpg&quot;&gt;
    &lt;img src=&quot;/images/bigwig/team.jpg&quot; alt=&quot;&quot; title=&quot;Smells like BEAM spirit&quot; width=&quot;500&quot; class=&quot;aligncenter size-full&quot; /&gt;
&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;what-a-bunch-of-tools&quot;&gt;What a bunch of tools‚Ä¶&lt;/h2&gt;

&lt;p&gt;The Erlang VM lets you inspect all aspects of a running node, examine running
processes, explore process hierarchies, and profile running systems.
This is typically done from the Erlang console, but if you‚Äôre feeling
especially nostalgic, you can start Erlang‚Äôs appmon (a real GUI app), or 
‚Äúwebtool‚Äù, a web-based version of some of the tools:&lt;/p&gt;

&lt;h3 id=&quot;erlangs-webtool-and-appmon&quot;&gt;Erlang‚Äôs Webtool and Appmon&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;/images/bigwig/webtool-orig.png&quot;&gt;
    &lt;img src=&quot;/images/bigwig/webtool-orig.png&quot; alt=&quot;&quot; title=&quot;Erlang&apos;s Webtool&quot; width=&quot;500&quot; class=&quot;aligncenter size-full&quot; /&gt;
&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/images/bigwig/appmon-orig.png&quot;&gt;
    &lt;img src=&quot;/images/bigwig/appmon-orig.png&quot; alt=&quot;&quot; title=&quot;Erlang&apos;s Appmon, and other tools&quot; width=&quot;500&quot; class=&quot;aligncenter size-full&quot; /&gt;
&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;bigwig&quot;&gt;BigWig&lt;/h2&gt;

&lt;p&gt;Our project, called BigWig, is a modern suite of web-based tools that we hope
will eventually supercede webtool, appmon and the rest.&lt;/p&gt;

&lt;h3 id=&quot;processes-etop&quot;&gt;Processes (etop)&lt;/h3&gt;

&lt;p&gt;Our version of etop, a realtime-updating, sortable process list:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/images/bigwig/etop.png&quot;&gt;
    &lt;img src=&quot;/images/bigwig/etop.png&quot; alt=&quot;&quot; title=&quot;Bigwig&apos;s erlang process viewer&quot; width=&quot;500&quot; class=&quot;aligncenter size-full&quot; /&gt;
&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;process-info&quot;&gt;Process Info&lt;/h3&gt;

&lt;p&gt;Click on a process ID anywhere in the app, and you get a process info dialog,
where you can see the state of the process, kill it and send messages:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/images/bigwig/pid.png&quot;&gt;
    &lt;img src=&quot;/images/bigwig/pid.png&quot; alt=&quot;&quot; title=&quot;Process info dialog&quot; width=&quot;500&quot; class=&quot;aligncenter size-full&quot; /&gt;
&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;application-explorer-appmon&quot;&gt;Application Explorer (appmon)&lt;/h3&gt;

&lt;p&gt;Explore the application supervison-tree hierarchy in style. You can click
around and more nodes are loaded in on-demand, and changes are sent to the page
updating the graph as they happen:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/images/bigwig/appmon.png&quot;&gt;
    &lt;img src=&quot;/images/bigwig/appmon.png&quot; alt=&quot;&quot; title=&quot;Bigwig&apos;s application explorer&quot; width=&quot;500&quot; class=&quot;aligncenter size-full&quot; /&gt;
&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;sasl-report-browser&quot;&gt;SASL Report Browser&lt;/h3&gt;

&lt;p&gt;This one isn‚Äôt quite finished yet, but is intended to be a nice way to browse
SASL reports instead of report browser (rb.erl).&lt;/p&gt;

&lt;p&gt;We opted to read the existing SASL binary dir format, instead of installing our
own event handler that logged reports differently. This was probably a mistake,
since log_mf_h handler and rb.erl are pretty dated, and designed specifically
to render reports as text to stdout. At the moment we do install a custom event
handler, but only so we can stream new reports to the browser as they happen.&lt;/p&gt;

&lt;p&gt;We‚Äôll tidy it up, but ultimately I think we should be installing our own
event handler and storing reports in a nicer way - possibly couch, or even just
update the code to use disk_log, and separate out the rendering bits.&lt;/p&gt;

&lt;h3 id=&quot;dashboard&quot;&gt;Dashboard&lt;/h3&gt;

&lt;p&gt;Shows the list of installed and loaded applications, which releases are
installed, according to release_handler, and details about the VM.&lt;/p&gt;

&lt;p&gt;We ran out of time at the weekend, so you just see the JSON for now:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/images/bigwig/dashboard.png&quot;&gt;
    &lt;img src=&quot;/images/bigwig/dashboard.png&quot; alt=&quot;&quot; title=&quot;Bigwig&apos;s dashboard&quot; width=&quot;500&quot; class=&quot;aligncenter size-full&quot; /&gt;
&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;bigwig-architecture&quot;&gt;BigWig Architecture&lt;/h2&gt;

&lt;p&gt;We used &lt;a target=&quot;new&quot; href=&quot;https://github.com/extend/cowboy&quot;&gt;cowboy&lt;/a&gt; as our webserver, and
make extensive use of websockets. For example, those sparkline graphs and
metrics in the left sidebar are pushed to the page, and updated every couple of
seconds.&lt;/p&gt;

&lt;p&gt;At the moment, BigWig only inspects the node it is currently running on. The
plan is to make it start up as a hidden node, and let you specify which nodes
to monitor by providing a nodename and cookie.&lt;/p&gt;

&lt;h2 id=&quot;source-code&quot;&gt;Source Code&lt;/h2&gt;

&lt;p&gt;All on github here: &lt;a href=&quot;https://github.com/beamspirit/bigwig&quot;&gt;BigWig for
Erlang&lt;/a&gt;. Licensed the same as Erlang/OTP.&lt;/p&gt;

&lt;p&gt;Check the readme - installing and running is easy!&lt;/p&gt;

</description>
        <pubDate>Mon, 11 Jul 2011 00:00:00 -0500</pubDate>
        <link>http://0.0.0.0:4000/article/bigwig-erlang-webtool-spawnfest</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/article/bigwig-erlang-webtool-spawnfest</guid>
        
        <category>programming</category>
        
        <category>erlang</category>
        
        <category>webtool</category>
        
        <category>spawnfest</category>
        
        <category>etop</category>
        
        <category>appmon</category>
        
        <category>sasl</category>
        
        
      </item>
    
      <item>
        <title>Erlang rebar tutorial: generating releases and upgrades</title>
        <description>&lt;p&gt;During my experiments with rebar, I made a simple example app for testing
upgrades and releases. This article will walk you through using rebar to create
an application, lay it out properly, package and deploy it, and create and
install new versions without downtime.&lt;/p&gt;

&lt;p&gt;The code accompanying this article is in various branches of &lt;a href=&quot;https://github.com/RJ/erlang_rebar_example_project&quot;&gt;github.com/RJ/erlang_rebar_example_project&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;N.B.&lt;/strong&gt; The &lt;a href=&quot;http://www.erlang.org/doc/design_principles/des_princ.html&quot;&gt;OTP
Design Principles&lt;/a&gt; docs are a good place to start if you want an overview of
the OTP approach to Erlang apps and releases. However, rebar isn‚Äôt (yet) part
of OTP, so consider that background reading. Rebar makes things much easier.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;creating-the-project&quot;&gt;Creating the project&lt;/h2&gt;

&lt;p&gt;Build rebar:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; ~/src
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;git clone https://github.com/basho/rebar.git
&lt;span class=&quot;go&quot;&gt;Initialized empty Git repository in /tmp/rebar/.git/
remote: Counting objects: 2651, done.
remote: Compressing objects: 100% (1344/1344), done.
remote: Total 2651 (delta 1540), reused 2227 (delta 1174)
Receiving objects: 100% (2651/2651), 622.99 KiB | 495 KiB/s, done.
Resolving deltas: 100% (1540/1540), done.
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;rebar &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; make
&lt;span class=&quot;go&quot;&gt;...snip....
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;==&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;rebar &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;compile&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;Congratulations! You now have a self-contained script called &quot;rebar&quot; in
your current working directory. Place this script anywhere in your path
and you can use rebar to build OTP-compliant apps.
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now we‚Äôll make a project directory called ‚Äúdummy_proj‚Äù, copy rebar into it, and use rebar to generate a skeleton application:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkdir&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; ~/src/dummy_proj/apps
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; ~/src/dummy_proj/
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; ../rebar/rebar &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;apps
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;../rebar create-app &lt;span class=&quot;nv&quot;&gt;appid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dummy_proj
&lt;span class=&quot;gp&quot;&gt;==&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;create-app&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;Writing src/dummy_proj.app.src
Writing src/dummy_proj_app.erl
Writing src/dummy_proj_sup.erl
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;To the skeleton, I added a basic gen_server called dummy_proj_server, which just keeps track of the
number of times it was poked, i.e. it holds some state, for demonstration purposes.&lt;/p&gt;

&lt;p&gt;I also renamed dummy_proj_app.erl to just dummy_proj.erl, and added a start/0 function, which is useful when starting the application during developement, when not running from a generated release.&lt;/p&gt;

&lt;h3 id=&quot;compiling-with-rebar&quot;&gt;Compiling with rebar&lt;/h3&gt;

&lt;p&gt;You need a rebar.conf, place this in the top-level project directory:&lt;/p&gt;

&lt;div class=&quot;language-erlang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sub_dirs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;&quot;apps/dummy_proj&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;s&quot;&gt;&quot;rel&quot;&lt;/span&gt;
           &lt;span class=&quot;p&quot;&gt;]}.&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;erl_opts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;debug_info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fail_on_warning&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]}.&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;require_otp_vsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;R14&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And now to compile, you do:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;./rebar compile
&lt;span class=&quot;gp&quot;&gt;==&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;compile&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;Compiled src/dummy_proj_sup.erl
Compiled src/dummy_proj.erl
Compiled src/dummy_proj_server.erl
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;==&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;rel &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;compile&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;==&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;compile&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that you now have .beam files in apps/dummy_proj/ebin/, and the .app.src generated apps/dummy_proj/ebin/dummy_proj.app for you, with a complete modules list.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;N.B.&lt;/strong&gt; I made a simple Makefile that calls ‚Äòrebar compile‚Äô, because I‚Äôm too used to typing make. Find it in the git repo.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;running-your-app-development&quot;&gt;Running your app (development)&lt;/h3&gt;

&lt;p&gt;Here‚Äôs how you can start the application (and sasl, for nice error reporting):&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;erl &lt;span class=&quot;nt&quot;&gt;-pa&lt;/span&gt; apps/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;/ebin &lt;span class=&quot;nt&quot;&gt;-boot&lt;/span&gt; start_sasl &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; dummy_proj
&lt;span class=&quot;go&quot;&gt;...snip...
=INFO REPORT==== 16-Mar-2011::14:17:04 ===
Starting dummy_proj application...

=PROGRESS REPORT==== 16-Mar-2011::14:17:04 ===
          supervisor: {local,dummy_proj_sup}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;             started: [{pid,&amp;lt;0.45.0&amp;gt;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;,
&lt;span class=&quot;go&quot;&gt;                       {name,dummy_proj_server},
                       {mfargs,{dummy_proj_server,start_link,[]} },
                       {restart_type,permanent},
                       {shutdown,5000},
                       {child_type,worker}]

=PROGRESS REPORT==== 16-Mar-2011::14:17:04 ===
         application: dummy_proj
          started_at: nonode@nohost
Eshell V5.8.1  (abort with ^G)
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;1&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj_server:num_pokes&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;0
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;2&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj_server:poke&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;     
&lt;span class=&quot;go&quot;&gt;{ok,1}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;3&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj_server:poke&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;{ok,2}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;4&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj_server:num_pokes&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;2
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;5&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;  
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now you have a nice sensibly structured Erlang project that you can compile with rebar. Exit the VM with q(). and let‚Äôs use rebar to package it up, so you can deploy it on a production box.&lt;/p&gt;

&lt;h2 id=&quot;generating-your-first-release&quot;&gt;Generating your first release&lt;/h2&gt;

&lt;p&gt;When you generate a release with rebar, and indeed if you use the erlang tools manually (not recommended, just use rebar), you end up with the whole Erlang VM and required libraries packaged up under one directory.&lt;/p&gt;

&lt;p&gt;This means you have a self-contained environment containing Erlang, the OTP libraries you need, and all your application code and dependencies. You can just tar it up, ship it over to another machine (of the same architecture, eg GNU/Linux 64-bit), and run it there.&lt;/p&gt;

&lt;h3 id=&quot;creating-a-node-config&quot;&gt;Creating a node config&lt;/h3&gt;

&lt;p&gt;Use rebar to create a default node configuration in a rel subdirectory:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mkdir &lt;/span&gt;rel
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;rel/
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;../rebar create-node &lt;span class=&quot;nv&quot;&gt;nodeid&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dummynode
&lt;span class=&quot;gp&quot;&gt;==&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;rel &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;create-node&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;Writing reltool.config
Writing files/erl
Writing files/nodetool
Writing files/dummynode
Writing files/app.config
Writing files/vm.args
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You need to edit reltool.config a little; point to to your apps directory, and
make sure the version number matches your .app.src file.
You should also add dummy_app to the list of applications that are started as part of the
release. 
Here‚Äôs &lt;a href=&quot;https://github.com/RJ/erlang_rebar_example_project/blob/v1/rel/reltool.config&quot; target=&quot;v1rel&quot;&gt;reltool.conf from my v1 tag&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;generating-the-release&quot;&gt;Generating the release&lt;/h3&gt;

&lt;p&gt;Back in the top level directory, just run:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;./rebar generate
&lt;span class=&quot;gp&quot;&gt;==&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;rel &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;generate&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now have a look in rel/dummynode. This is the release directory containing everything you need to run your application.&lt;/p&gt;

&lt;p&gt;We are going to be creating more releases later, so rename rel/dummynode to rel/dummynode_first, and then launch it using the handy script that rebar created for us:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;rel/dummynode_first
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;./bin/dummynode console
&lt;span class=&quot;go&quot;&gt;...snip...
Erlang R14B (erts-5.8.1) [source] [64-bit] [smp:8:8] [rq:8] [async-threads:5] [hipe] [kernel-poll:true
=INFO REPORT==== 16-Mar-2011::13:29:59 ===
Starting dummy_proj application...
Eshell V5.8.1  (abort with ^G)
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)1&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; 
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)1&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj_server:num_pokes&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;0
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)2&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj_server:poke&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;     
&lt;span class=&quot;go&quot;&gt;{ok,1}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)3&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj_server:poke&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;{ok,2}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)4&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj_server:num_pokes&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;2
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)5&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; 
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now the release is running, we never want to have to restart it ever again, so open up another console because we want to leave that running whilst we work on version 2.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;N.B.&lt;/strong&gt; In a production environment, you would start with ‚Äú./bin/dummynode start‚Äù so it runs in the background, and use ‚Äúdummynode attach‚Äù to get a console.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Check the &lt;a href=&quot;https://github.com/RJ/erlang_rebar_example_project/blob/v1/&quot;&gt;‚Äòv1 branch‚Äô&lt;/a&gt; on github for code up to this point.&lt;/p&gt;

&lt;h2 id=&quot;upgrading-to-version-2&quot;&gt;Upgrading to Version 2&lt;/h2&gt;

&lt;p&gt;Add the poke_twice() function to dummy_proj_server.&lt;/p&gt;

&lt;p&gt;Change the version from ‚Äú1‚Äù to ‚Äú2‚Äù, in both apps/dummy_proj.app.src and rel/reltool.conf.&lt;/p&gt;

&lt;p&gt;Here‚Äôs the github &lt;a href=&quot;https://github.com/RJ/erlang_rebar_example_project/compare/v1...v2#diff-3&quot;&gt;diff between v1‚Ä¶v2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Erlang application version numbers can be any string - I tend to use a date format with letter: ‚Äú20110316a‚Äù, but you can use any scheme you want. 
I tag releases in git with the same version as the erlang application. 
We‚Äôll just use ‚Äú1‚Äù, ‚Äú2‚Äù, ‚Äú3‚Äù here for simplicity.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;N.B.&lt;/strong&gt; If you use &lt;code&gt;{vsn, git}&lt;/code&gt; as the version in your .app.src, rebar will get the version string from the closest git tag.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Now build the new version:&lt;/p&gt;
&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;./rebar compile
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;./rebar generate
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So now you have rel/dummy_proj, containing a full release (VM included) of version 2. 
If you don‚Äôt care about online-upgrades, you could just kill your version 1 VM, and start version 2 from this new release directory.&lt;/p&gt;

&lt;h3 id=&quot;writing-the-appup-upgrade-instructions&quot;&gt;Writing the .appup upgrade instructions&lt;/h3&gt;

&lt;p&gt;In order to make an upgrade, you must have a valid .appup file. 
This tells the erlang release_handler how to upgrade and downgrade between specific versions of your application.&lt;/p&gt;

&lt;p&gt;Rebar has a (relatively new) command called ‚Äògenerate-appups‚Äô. 
I‚Äôll show how it works, but ultimately we‚Äôll write our .appup manually, and keep it in our project directory (in git).&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;./rebar generate-appups &lt;span class=&quot;nv&quot;&gt;previous_release&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dummynode_first
&lt;span class=&quot;gp&quot;&gt;==&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;rel &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;generate-appups&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;Generated appup for dummy_proj
Appup generation complete
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; ./rel/dummynode/lib/dummy_proj-2/ebin/dummy_proj.appup
&lt;span class=&quot;go&quot;&gt;%% appup generated for dummy_proj by rebar (&quot;2011/03/16 13:37:43&quot;)¬¨                                   
{&quot;2&quot;, [{&quot;1&quot;, [{update,dummy_proj_server,{advanced,[]}}]}], [{&quot;1&quot;, []}]}.¬¨
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Get rid of the autogenerated one, and create the appup file manually, in apps/dummy_proj/ebin/dummy_proj.appup:&lt;/p&gt;

&lt;div class=&quot;language-erlang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
    &lt;span class=&quot;c&quot;&gt;%% Upgrade instructions from 1 to 2
&lt;/span&gt;    &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;load_module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dummy_proj_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;    
    &lt;span class=&quot;p&quot;&gt;]}],&lt;/span&gt; 
    &lt;span class=&quot;c&quot;&gt;%% Downgrade instructions from 2 to 1
&lt;/span&gt;    &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,[&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;load_module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dummy_proj_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;    
    &lt;span class=&quot;p&quot;&gt;]}]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This .appup contains instructions for upgrading and downgrading between versions ‚Äú2‚Äù and ‚Äú1‚Äù.
Typically the downgrade instructions are the reverse of the upgrade instructions. 
Since we just added a function to our server process, without changing any internal state, we can just use load_module instructions. The Appup Cookbook explains the various upgrade instructions in depth.&lt;/p&gt;

&lt;p&gt;Now generate again, overwriting the previous version 2. This will just make sure the .appup is part of the release directory:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;./rebar generate &lt;span class=&quot;nt&quot;&gt;-f&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And now, create the upgrade package:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;./rebar generate-upgrade &lt;span class=&quot;nv&quot;&gt;previous_release&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dummynode_first
&lt;span class=&quot;gp&quot;&gt;==&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;rel &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;generate-upgrade&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;dummynode_2 upgrade package created
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The generate-upgrade command will look for rel/dummynode as the current version, and rel/dummynode_first as the previous version. 
It should have created the upgrade .tar.gz in rel:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-lh&lt;/span&gt; rel/
&lt;span class=&quot;go&quot;&gt;total 15M
drwxr-xr-x 8 rj rj 4.0K 2011-03-16 13:42 dummynode
drwxr-xr-x 8 rj rj 4.0K 2011-03-16 13:29 dummynode_first
-rw-r--r-- 1 rj rj  14M 2011-03-16 13:45 dummynode_2.tar.gz
drwxr-xr-x 2 rj rj 4.0K 2011-03-16 13:11 files
-rw-r--r-- 1 rj rj  922 2011-03-16 13:36 reltool.config
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;installing-the-upgrade-package&quot;&gt;Installing the upgrade package&lt;/h3&gt;

&lt;p&gt;You should still have the VM running from dummynode_first. 
Make sure you called poke(), so the internal state is something other than the default. 
This will help illustrate that the upgrade worked seamlessly.&lt;/p&gt;

&lt;p&gt;Copy the upgrade package to the releases directory of the running release:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;rel/dummynode_2.tar.gz rel/dummynode_first/releases
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, at the Erlang console where version 1 is running, we use release_handler to check which releases are currently available, and install our new one:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)5&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;release_handler:which_releases&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;[{&quot;dummynode&quot;,&quot;1&quot;,[],permanent}]
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)6&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;release_handler:unpack_release&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;dummynode_2&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;{ok,&quot;2&quot;}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)7&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;release_handler:install_release&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;{ok,&quot;1&quot;,[]}   
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)8&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj_server:num_pokes&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;2
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)9&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj_server:poke_twice&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;{ok,4}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)10&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;dummy_proj_server:num_pokes&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; 
&lt;span class=&quot;go&quot;&gt;4
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)11&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;release_handler:which_releases&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;[{&quot;dummynode&quot;,&quot;2&quot;,
  [&quot;kernel-2.14.1&quot;,&quot;stdlib-1.17.1&quot;,&quot;dummy_proj-2&quot;,
   &quot;sasl-2.1.9.2&quot;,&quot;compiler-4.7.1&quot;,&quot;crypto-2.0.1&quot;,
   &quot;syntax_tools-1.6.6&quot;,&quot;edoc-0.7.6.7&quot;,&quot;et-1.4.1&quot;,&quot;gs-1.5.13&quot;,
   &quot;hipe-3.7.7&quot;,&quot;inets-5.5&quot;,&quot;mnesia-4.4.15&quot;,&quot;observer-0.9.8.3&quot;,
   &quot;public_key-0.8&quot;,&quot;runtime_tools-1.8.4.1&quot;,&quot;ssl-4.0.1&quot;,
   &quot;tools-2.6.6.1&quot;,&quot;webtool-0.8.7&quot;,&quot;wx-0.98.7&quot;,&quot;xmerl-1.2.6&quot;],
  current},
 {&quot;dummynode&quot;,&quot;1&quot;,[],permanent}]
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The upgrade worked; you can see that the num_pokes() was preserved, and that the new poke_twice() function is available.&lt;/p&gt;

&lt;p&gt;release_handler shows our version 2 as ‚Äúcurrent‚Äù, and the original version 1 as ‚Äúpermanent‚Äù.
This means that although version 2 is running right now, if you restart the VM, version ‚Äú1‚Äù will be booted up.&lt;/p&gt;

&lt;p&gt;If you are happy with the upgrade, make it permanent, meaning it will boot instead of version 1 if you restart the VM:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)12&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;release_handler:make_permanent&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Check the &lt;a href=&quot;https://github.com/RJ/erlang_rebar_example_project/blob/v2/&quot;&gt;‚Äòv2 branch‚Äô&lt;/a&gt; on github for code up to this point.&lt;/p&gt;

&lt;h2 id=&quot;version-3-and-beyond&quot;&gt;Version 3 and beyond&lt;/h2&gt;

&lt;p&gt;The upgrade from v1 to v2 was simple: we just added a fun without changing the
internal #state{} record.&lt;/p&gt;

&lt;p&gt;Erlang .appup files can do all sorts of clever stuff, allowing you to rewire
your running applications during the upgrade process.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;http://www.erlang.org/doc/design_principles/appup_cookbook.html&quot;&gt;Appup
Cookbook&lt;/a&gt; details the various commands you can put in your .appup.&lt;/p&gt;

&lt;p&gt;Let‚Äôs do an upgrade with a more complex appup - we‚Äôll change the #state record in the dummy_proj_server process.&lt;/p&gt;

&lt;p&gt;For version 3, we‚Äôll track prods as well as pokes, which will require another
field in the state record.&lt;/p&gt;

&lt;p&gt;Here‚Äôs the github &lt;a href=&quot;https://github.com/RJ/erlang_rebar_example_project/compare/v2...v3#diff-2&quot;&gt;diff between v2‚Ä¶v3&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Check out the addition to .appup for this release:&lt;/p&gt;

&lt;div class=&quot;language-erlang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;3&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
    &lt;span class=&quot;c&quot;&gt;%% Upgrade instructions
&lt;/span&gt;    &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dummy_app_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;advanced&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;from2to3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]}}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;]}],&lt;/span&gt; 
    &lt;span class=&quot;c&quot;&gt;%% Downgrade instructions
&lt;/span&gt;    &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,[&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;update&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dummy_app_server&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;advanced&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;from3to2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]}}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;]}]&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This {update..} directive will result in the code_change function being called
on the dummy_app_server. The purpose of code_change is to change the State from
the old (v2) format, to the new (v3) format.&lt;/p&gt;

&lt;p&gt;Although it‚Äôs not strictly necessary, I pass ‚Äòfrom2to3‚Äô as the ‚ÄòExtra‚Äô field in
the code_change call. This can be pattern matched on, and makes it clear in
your code_change code exactly what version upgrade is expected.&lt;/p&gt;

&lt;h3 id=&quot;packaging-and-upgrading-to-v3&quot;&gt;Packaging and upgrading to v3&lt;/h3&gt;

&lt;p&gt;Move the generated release dir for v2:&lt;/p&gt;
&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;mv &lt;/span&gt;rel/dummynode rel/dummynode_2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Compile and generate for v3, then create the upgrade package:&lt;/p&gt;
&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;./rebar compile
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;./rebar generate
&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;./rebar generate-upgrade &lt;span class=&quot;nv&quot;&gt;previous_release&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;dummynode_2
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;N.B.&lt;/strong&gt; You need to provide the full, standalone generated release dir
as the previous_release, you can‚Äôt use dummynode_first, even though that
contains version 2 of your release.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;As before, copy the upgrade package to the releases directory of the running release:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cp &lt;/span&gt;rel/dummynode_3.tar.gz rel/dummynode_first/releases
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, at the Erlang console where you upgraded v1 to v2:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)12&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;release_handler:unpack_release&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;dummynode_3&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;{ok,&quot;3&quot;}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;(dummynode@127.0.0.1)13&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;release_handler:install_release&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;3&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;{ok,&quot;2&quot;,[]}
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;congratulations&quot;&gt;Congratulations&lt;/h3&gt;

&lt;p&gt;Now you can deploy hot-code-upgrades the proper OTP way. Ideal for complex or
large upgrades that change internal state or do require special upgrade hooks.
Read the Appup Cookbook a few times, and &lt;strong&gt;test your upgrade packages in
a staging environment before deploying&lt;/strong&gt;. You can just tar up and copy the live
environment to your staging box, to get an exact clone of the production system
to test upgrades against.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Warning: a current issue with downgrades&lt;/strong&gt;&lt;/p&gt;

  &lt;p&gt;To downgrade, you just install a previous release. However, there is currently
a bug where release_handler chokes during downgrades to the first version,
because of a discrepancy in the naming of .boot files in the release.
release_handler has start.boot hardcoded, but rebar will generate appname.boot,
with start.boot as a symlink. If you need to do downgrades, test this carefully
before deploying; you may need to manually rename the boot file.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h2 id=&quot;cowboying-out-quick-fixes&quot;&gt;Cowboying out quick fixes&lt;/h2&gt;

&lt;p&gt;Appup files and generating releases is rather heavyweight. Here‚Äôs an overview
of the process I‚Äôm using on &lt;a href=&quot;https://www.irccloud.com/&quot;&gt;IRCCloud&lt;/a&gt; at the moment&lt;/p&gt;

&lt;h4 id=&quot;complex-upgrades-are-proper-releases-with-appup&quot;&gt;Complex upgrades are proper releases, with .appup&lt;/h4&gt;

&lt;p&gt;No way around it; bit of a pain to create and test, but glorious when you pull off a complex upgrade with zero downtime.
Releases are tagged in git with the datetime and letter version, eg:
v20110324a.
If I do a second release that day, v20110324b.&lt;/p&gt;

&lt;h4 id=&quot;hotfixes-preserve-my-sanity&quot;&gt;‚ÄòHotfixes‚Äô preserve my sanity&lt;/h4&gt;

&lt;p&gt;If I make a quick fix that simply requires reloading a module with no risk of
instability, I do the following:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Reset code to currently deployed tag, egv 20110324a&lt;/li&gt;
  &lt;li&gt;Write the fix&lt;/li&gt;
  &lt;li&gt;Commit as v200110324a-hotfix1&lt;/li&gt;
  &lt;li&gt;Build this version of the specific module that‚Äôs changed, and copy it into
the production environment, eg to:
/somewhere/dummyapp/lib/dummyapp-20110324a/ebin/&lt;/li&gt;
  &lt;li&gt;Reload the module, eg by using l(module_name). at the shell.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;It‚Äôs of vital importance to have a repeatable process, so you know exactly which version of
code (ie, the git tag) is currently running in production. If you can‚Äôt be
sure, then it‚Äôs much harder to write successful upgrade code later on.&lt;/p&gt;

&lt;p&gt;This process gives a reasonable balance between periodic ‚Äòproper‚Äô releases,
during which any complex changes are made that rewire internal state, and quick
fixes that just require a module reload.&lt;/p&gt;

&lt;h2 id=&quot;pitfalls-to-avoid&quot;&gt;Pitfalls to avoid&lt;/h2&gt;

&lt;p&gt;In the IRCCloud app, there‚Äôs one place that I don‚Äôt use a supervisor, but wish
I had; the user process acts as a sort of supervisor for connection processes, 
because I needed exponential backoff / more control over restarting crashed children.&lt;/p&gt;

&lt;p&gt;Don‚Äôt do that. release_handler isn‚Äôt aware of the child processes I spawn
myself, so I can‚Äôt use the normal appup process to call code_change.&lt;/p&gt;

</description>
        <pubDate>Sat, 26 Mar 2011 00:00:00 -0500</pubDate>
        <link>http://0.0.0.0:4000/article/erlang-rebar-tutorial-generating-releases-upgrades</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/article/erlang-rebar-tutorial-generating-releases-upgrades</guid>
        
        <category>programming</category>
        
        <category>erlang</category>
        
        <category>otp</category>
        
        <category>appup</category>
        
        <category>rebar</category>
        
        <category>releasehandler</category>
        
        
      </item>
    
      <item>
        <title>Erlang/OTP releases: rebar, release_handler, .appup, etc</title>
        <description>&lt;p&gt;I‚Äôve been building something in Erlang recently, provisionally called &lt;a title=&quot;It&apos;s the Gmail of IRC, honest!&quot; href=&quot;https://irccloud.com/&quot; target=&quot;_blank&quot;&gt;IRCCloud.com&lt;/a&gt; (mention this post if you request an invite!) - it‚Äôs an in-browser IRC client that stays connected for you all the time, so you never miss the conversation. You can reopen your browser later and still have all the backlog.¬†&lt;a title=&quot;IRC: still damn useful&quot; href=&quot;http://www.metabrew.com/article/how-we-use-irc-at-lastfm&quot; target=&quot;_blank&quot;&gt;IRC is damn useful&lt;/a&gt;, and¬†&lt;a title=&quot;James Wheare: International man of mystery&quot; href=&quot;http://james.wheare.org/&quot; target=&quot;_blank&quot;&gt;James&lt;/a&gt; and I are building IRCCloud to give you the advantages of IRC bouncer-esque functionality, with the ease of just opening a webpage.&lt;/p&gt;

&lt;p&gt;The Erlang backend is connected to various IRC servers on behalf of our users, so it‚Äôs critical that I can deploy new versions of the app without restarting. Erlang‚Äôs capability to do live upgrades to running applications means it‚Äôs possible to deploy new versions of the backend without disconnecting everybody. I‚Äôve done a fair amount of Erlang before, but I‚Äôve only recently managed to get proper live-updates to running OTP applications working.&lt;/p&gt;

&lt;p&gt;Previous upgrade experience ranged from just copying over a new beam and running &lt;code&gt;l(my_module).&lt;/code&gt; in the shell, to manually triggering code_change like this:&lt;/p&gt;

&lt;div class=&quot;language-erlang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nn&quot;&gt;sys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;suspend&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;my_module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;code&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;load_file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;my_module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;sys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;change_code&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;my_module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[],&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;10000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;sys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;resume&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If you want to start doing complex updates that change internal state, amongst other things, you really want to be doing it in the proper OTP way.&lt;/p&gt;

&lt;p&gt;I started with this &lt;a title=&quot;A good read&quot; href=&quot;http://spawnlink.com/articles/performing-real-time-upgrades-to-an-otp-system/&quot; target=&quot;_blank&quot;&gt;excellent series of articles about Erlybank, on spawnlink.com&lt;/a&gt;. I definitely recommend following along the last couple in the series to get a feel for packaging up erlang releases. I‚Äôm not going to provide a step-by-step tutorial in this post, since Mitchell already did a great job in those articles.&lt;/p&gt;

&lt;p&gt;Unfortunately I fell at the last hurdle - I ran into the same problem as Ricardo in the comments, namely that &lt;a href=&quot;http://spawnlink.com/articles/performing-real-time-upgrades-to-an-otp-system/#comments&quot; target=&quot;_blank&quot;&gt;release_hander was looking for the .appup file in the wrong place&lt;/a&gt;. I don‚Äôt know why this happens, but it seems that because I had the erlang system itself as a ‚Äúrelease‚Äù (R13B etc), that somehow screwed things up. I found one other &lt;a title=&quot;Annoying.&quot; href=&quot;http://erlang.2086793.n4.nabble.com/install-release-1-always-returns-enoent-error-td2093926.html&quot; target=&quot;_blank&quot;&gt;post about the same problem&lt;/a&gt;. If you know what‚Äôs going on here, please leave a comment and put me out of my misery.&lt;/p&gt;

&lt;h2 id=&quot;upgrade-to-r14&quot;&gt;Upgrade to R14!&lt;/h2&gt;

&lt;p&gt;Let me get this out the way first: &lt;strong&gt;upgrade your Erlang to R14 right now&lt;/strong&gt;, since R13B has a bug that prevents release_handler from figuring out which modules need updating when you install a new release. I lost some time to that, although consequently I did end up taking a nice tour of the sasl/release_handler/systools code.&amp;lt;/p&amp;gt;
Oh, and also ‚Äúrebar generate‚Äù (mentioned later in this post) will fail with some distro packaged versions of R13B04, with a message like:¬†&lt;em&gt;ERROR: Unable to generate spec: read file info /usr/lib/erlang/man/man5/modprobe.d.5 failed.&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&quot;first-target-system&quot;&gt;First Target System&lt;/h2&gt;

&lt;p&gt;So I decided to roll my own &lt;a href=&quot;http://www.erlang.org/doc/system_principles/create_target.html&quot; target=&quot;_blank&quot;&gt;First Target System&lt;/a&gt;. The fine manual says:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Often it is not desirable to use an Erlang/OTP system as is. A developer may create new Erlang/OTP compliant applications for a particular purpose, and several original Erlang/OTP applications may be irrelevant for the purpose in question. Thus, there is a need to be able to create a new system based on a given Erlang/OTP system, where dispensable applications are removed, and a set of new applications that are included in the new system. Documentation and source code is irrelevant and is therefore not included in the new system.&lt;/p&gt;

  &lt;p&gt;Another advantage of creating your own target system is that you get a guaranteed environment to deploy your code into - you can simply untar your system onto any machine (of the same platform/architecture) and it will run just like it ran on your test machine. Same exact version of Erlang, same exact libraries, same config.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;After following along with the manual, I had a shiny new target system - but much to my dismay I had a R13B directory under releases/, and trying to do an application upgrade resulted in the same problem as before: release_handler was still looking for an appup file under releases/R13B/ instead of releases/myapp/.&lt;/p&gt;

&lt;p&gt;I tried copying my .appup to R13B, and creating a valid blank appup, to no avail. ¬†So..&lt;/p&gt;

&lt;h2 id=&quot;rebar-to-the-rescue-sort-of&quot;&gt;Rebar to the rescue‚Ä¶ sort of&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;http://bitbucket.org/basho/rebar/wiki/Home&quot;&gt;Rebar&lt;/a&gt; is an erlang build tool with a few nifty tricks (thanks &lt;a title=&quot;Buy this man a pint.&quot; href=&quot;http://dizzyd.com/&quot; target=&quot;_blank&quot;&gt;Dave&lt;/a&gt; and the gang). Documentation/examples are still a little sparse, but one thing it does have in spades is a way to build Erlang target systems in one command: &lt;em&gt;./rebar generate&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;To use rebar to make a target system you‚Äôll need a working OTP style application in the &lt;a title=&quot;OTP Design principles: follow them!&quot; href=&quot;http://erlang.org/doc/design_principles/applications.html#id69069&quot; target=&quot;_blank&quot;&gt;usual layout&lt;/a&gt; (src,priv,ebin,include) with a valid .app file. Here are the &lt;a href=&quot;http://bitbucket.org/basho/rebar/wiki/ReleaseHandling&quot; target=&quot;_blank&quot;&gt;rebar release handling docs&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Okay. So now we have a nice target system (courtesy of rebar); your rel/&amp;lt;appname&amp;gt; directory will look like this:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;go&quot;&gt;drwxr-xr-x ¬†2 rj rj ¬† 21 2010-09-15 02:49 bin
drwxr-xr-x ¬†8 rj rj ¬† 70 2010-09-15 02:48 erts-5.8
drwxr-xr-x ¬†2 rj rj ¬† 37 2010-09-15 02:49 etc
drwxr-xr-x 27 rj rj 4096 2010-09-15 02:49 lib
drwxr-xr-x ¬†3 rj rj ¬† 17 2010-09-15 02:49 log
drwxr-xr-x ¬†3 rj rj ¬† 43 2010-09-15 02:48 releases
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The lib/ directory contains stdlib, sasl, kernel, your application and any other deps you specified; The releases/ directory is reassuring empty; bin/ contains a handy nodetool script to start and stop your app; sasl is configured to log to a file. Rebar just saved you a few hours of fiddling to get things up and running. But you‚Äôre not out of the woods yet..&lt;/p&gt;

&lt;h2 id=&quot;deploying-updates-to-rebar-packaged-target-system&quot;&gt;Deploying updates to rebar-packaged target system&lt;/h2&gt;

&lt;p&gt;This was the tricky non-obvious bit. Rebar was great at getting the first system with my app deployed, however it doesn‚Äôt really offer much to help you install an update to your running system.&lt;/p&gt;

&lt;p&gt;I wrote a script &lt;strong&gt;regen.sh&lt;/strong&gt; to use instead of ‚Äúrebar generate‚Äù, which post-processes the directory structure rebar generates, to make it more amenable to deploying upgrades:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;/bin/bash
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;This will nuke rel/irccloud and regenerate using rebar.. [enter to continue]&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;read
rm&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-rf&lt;/span&gt; rel/irccloud
&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt;
./rebar compile
./rebar generate
&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;rel/irccloud/lib/
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Unpacking .ez files&quot;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;f &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;.ez
&lt;span class=&quot;k&quot;&gt;do
&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;.&quot;&lt;/span&gt;
unzip &lt;span class=&quot;nv&quot;&gt;$f&lt;/span&gt; &amp;amp;gt&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; /dev/null
&lt;span class=&quot;nb&quot;&gt;rm&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$f&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;done
&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo
cd&lt;/span&gt; ../releases/
&lt;span class=&quot;c&quot;&gt;# Get the version of the only release in the system, our new app:&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;VER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;find &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-maxdepth&lt;/span&gt; 1 &lt;span class=&quot;nt&quot;&gt;-type&lt;/span&gt; d | &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-vE&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;^\.$&apos;&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;head&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-n1&lt;/span&gt; | &lt;span class=&quot;nb&quot;&gt;sed&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;s/^\.\///g&apos;&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Ver: &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;VER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;, renaming .rel + .boot files correctly&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;VER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;mv &lt;/span&gt;irccloud.boot start.boot
&lt;span class=&quot;nb&quot;&gt;mv &lt;/span&gt;irccloud.rel &lt;span class=&quot;s2&quot;&gt;&quot;irccloud-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;VER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.rel&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; ../../../
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;OK&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This does three important things:&lt;/p&gt;
&lt;ol&gt;
  &lt;li&gt;Unpack the *.ez files (zip files of applications in lib/), since upgrades with release_handler didn‚Äôt work otherwise;&lt;/li&gt;
  &lt;li&gt;rename irccloud.boot to start.boot, &lt;a title=&quot;Erldocs.com is great&quot; href=&quot;http://erldocs.com/R14A/sasl/systools.html?i=5&amp;amp;search=systools#make_tar/1&quot; target=&quot;_blank&quot;&gt;since systools has ‚Äústart.boot‚Äù hardcoded&lt;/a&gt; as the correct name of this file for packages;&lt;/li&gt;
  &lt;li&gt;rename irccloud.rel to irccloud-&amp;lt;VERSION&amp;gt;.rel, since this is the standard layout for future packages.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;NB: I think I also had to change the bin/irccloud script to -boot with Ôªø&lt;code&gt;$RUNNER_BASE_DIR/releases/$APP_VSN/start&lt;/code&gt; instead of &lt;code&gt;$RUNNER_BASE_DIR/releases/$APP_VSN/$SCRIPT&lt;/code&gt;&lt;/em&gt;&lt;/p&gt;

&lt;h2 id=&quot;tooling-up-for-easier-releases&quot;&gt;Tooling up for easier releases&lt;/h2&gt;

&lt;p&gt;Now in the top level directory (alongside rel,src,ebin..) I made a releases/ directory, from which I package up new versions ready for deployment.&lt;/p&gt;

&lt;p&gt;I‚Äôm using a bash script, and some erlang, to facilitate packaging up new releases. Note that it adds, using erl -pz, the paths to the current .app file and beams, and the previous .app file and beams.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;ERL_ROOT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;OLDVER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$2&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;VER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$3&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; ..
./rebar compile
&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; -
&lt;span class=&quot;nv&quot;&gt;OLDEBIN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ERL_ROOT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/lib/irccloud-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;OLDVER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/ebin/&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Fetching previous rel file: irccloud-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;OLDVER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.rel from &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ERL_ROOT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/releases/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;OLDVER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ERL_ROOT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/releases/&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;OLDVER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/irccloud-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;OLDVER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.rel&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;irccloud-&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;OLDVER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.rel&quot;&lt;/span&gt;

erl &lt;span class=&quot;nt&quot;&gt;-pz&lt;/span&gt; ../ebin/ &lt;span class=&quot;nt&quot;&gt;-pz&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;OLDEBIN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-pz&lt;/span&gt; ../deps/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;/ebin &lt;span class=&quot;nt&quot;&gt;-noshell&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;-run&lt;/span&gt; release_helper go irccloud &lt;span class=&quot;nv&quot;&gt;$VER&lt;/span&gt; ../ebin &lt;span class=&quot;nv&quot;&gt;$OLDVER&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;OLDEBIN&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
| &lt;span class=&quot;nb&quot;&gt;grep&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;Source code not found&apos;&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Release &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;VER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; packaged&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;release_helpererl&quot;&gt;release_helper.erl&lt;/h3&gt;

&lt;div class=&quot;language-erlang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;% Check some stuff, write the .rel file, generate boot scripts and relup, make tar
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;ni&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;release_helper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;ni&quot;&gt;export&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;go&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]).&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;ni&quot;&gt;define&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;RELAPPS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;kernel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                    &lt;span class=&quot;n&quot;&gt;stdlib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                    &lt;span class=&quot;n&quot;&gt;sasl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                    &lt;span class=&quot;n&quot;&gt;crypto&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                    &lt;span class=&quot;n&quot;&gt;ssl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                    &lt;span class=&quot;n&quot;&gt;inets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;public_key&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                    &lt;span class=&quot;n&quot;&gt;compiler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;syntax_tools&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;edoc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;eunit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;xmerl&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;epgsql&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                    &lt;span class=&quot;n&quot;&gt;mochiweb&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]).&lt;/span&gt;

&lt;span class=&quot;nf&quot;&gt;appver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;when&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;is_atom&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Version of &apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~p&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;..&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;_,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Ret&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;lists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;keysearch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;loaded_applications&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()),&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~p~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Ret&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;Ret&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;

&lt;span class=&quot;nf&quot;&gt;check_appfile_version&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AppName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ExpectedVer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Verifying .app file contains correct version..&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,[]),&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AppName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Props&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;consult&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;proplists&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;get_value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;vsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Props&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;of&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;ExpectedVer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;ok&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,[]),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;FoundVer&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;FAIL&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;App file contains ver: &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; but expected: &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                             &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;FoundVer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;ExpectedVer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
                   &lt;span class=&quot;nf&quot;&gt;halt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;

&lt;span class=&quot;nf&quot;&gt;go&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; 
  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Ebin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;PVersion&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;PEbin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;release_helper running for: &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~p&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;, oldversion: &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;, new version: &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
            &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;PVersion&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt;        &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;check_appfile_version&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Ebin&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;/&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;.app&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; 
                                    &lt;span class=&quot;nb&quot;&gt;list_to_atom&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;Erts&lt;/span&gt;      &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;erlang&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;system_info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;version&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;Vsn&lt;/span&gt;       &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;io_lib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;PrevVsn&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;io_lib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;PVersion&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;version: &apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;AppVers&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;appver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)}&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;A&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;RELAPPS&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;Rel&lt;/span&gt;       &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; 
&lt;span class=&quot;s&quot;&gt;&quot;{release, 
    {&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;}, 
    {erts, &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;}, 
    [   {&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~w&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;},&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;        &quot;&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;
    &lt;span class=&quot;nn&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;join&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;io_lib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~w&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;, &lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;}&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;AV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;A&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;AV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;AppVers&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; 
                &lt;span class=&quot;s&quot;&gt;&quot;,&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;        &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;    ]&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;}.&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;RelText&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;io_lib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Rel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Erts&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;list_to_atom&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Version&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
  &lt;span class=&quot;nv&quot;&gt;Relfile&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;io_lib&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;.rel&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Vsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Writing &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Relfile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;  &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Relfile&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;write&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;RelText&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]),&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Fs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;make_script(&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~s&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;)..&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Vsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;systools&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;make_script&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Vsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;PVersion&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;of&lt;/span&gt; 
    &lt;span class=&quot;s&quot;&gt;&quot;0&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Previous version 0, not generating relup!&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;_&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;systools&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;make_relup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Vsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;PrevVsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;PrevVsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;systools&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;make_tar&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Vsn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;nf&quot;&gt;halt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;making-a-second-release&quot;&gt;Making a second release&lt;/h2&gt;

&lt;p&gt;Here&apos;s how I currently make a new release that can be deployed with a live-upgrade:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Fix bugs, change some stuff, add features etc;&lt;/li&gt;
&lt;li&gt;Update ebin/irccloud.app to increase the version number, update the modules list if needed;&lt;/li&gt;
&lt;li&gt;Create/modify ebin/irccloud.appup to tell release_handler how to upgrade from the previous version to this new version. (See: Appup Cookbook);&lt;/li&gt;
&lt;li&gt;&lt;code&gt;cd releases/&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;./release_helper.sh &quot;../rel/irccloud&quot; &quot;1&quot; &quot;2&quot;&lt;/code&gt; # (where &quot;1&quot; was the version of the first release using rebar generate, &quot;2&quot; is the new one we want to package)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Now I have irccloud-2.tar.gz in the releases/ directory, ready to be deployed. My packaging scripts also tag the release in git and a few other things I&apos;ve omitted for clarity.&lt;/p&gt;
&lt;h2&gt;Deploying the release&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;$ cp irccloud-2.tar.gz ../rel/irccloud/releases&lt;/code&gt; # or copy to whereever you put your target system on the production box instead of ../rel/irccloud&lt;/li&gt;
&lt;li&gt;&lt;code&gt;erl&amp;gt; release_handler:unpack_release(&quot;irccloud-2&quot;).&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;erl&amp;gt; release_handler:install_release(&quot;2&quot;).&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;erl&amp;gt; release_handler:which_releases().&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;erl&amp;gt; release_handler:make_permanent(&quot;2&quot;).&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Step 3 does the upgrade, and runs the appup stuff - hope you tested on your development rig before deploying to production!&lt;br /&gt;
If you wrote your .appup properly, it is also safe to downgrade - just do &lt;code&gt;release_helper:install_release(&quot;1&quot;).&lt;/code&gt; after step 3.&lt;/p&gt;
&lt;p&gt;Note, you must run erl with &quot;-boot start_sasl&quot; to use release_manager. I ran this from the same shell as &quot;bin/irccloud console&quot; which already had sasl running.&lt;/p&gt;
&lt;h2&gt;Mochiweb caveat&lt;/h2&gt;
&lt;p&gt;I&apos;m using the excellent &lt;a title=&quot;Mochiweb: I love it.&quot; href=&quot;http://github.com/mochi/mochiweb&quot; target=&quot;_blank&quot;&gt;Mochiweb HTTP library&lt;/a&gt; in my application. Here&apos;s the child specification from my top level supervisor:&lt;/p&gt;
&lt;pre lang=&quot;erlang&quot;&gt;{irccloud_web,
    {irccloud_web, start, [WebConfig]},
     permanent, 5000, worker, dynamic}&lt;/pre&gt;
&lt;p&gt;Note that it says &apos;dynamic&apos; in place of the modules list. Here&apos;s what the &lt;a href=&quot;http://erldocs.com/R14A/stdlib/supervisor.html&quot;&gt;fine manual&lt;/a&gt; says:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;strong&gt;Modules&lt;/strong&gt; is used by the release handler during code replacement to determine which processes are using a certain module. As a rule of thumb Modules should be a list with one element [Module], where Module is the callback module, if the child process is a supervisor, gen_server or gen_fsm. If the child process is an event manager (gen_event) with a dynamic set of callback modules, Modules should be dynamic. See OTP Design Principles for more information about release handling.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;What it doesn&apos;t say is that release_handler will timeout and screw your install because it can&apos;t find the list of modules when dynamic is specified, unless you answer correctly.&lt;/p&gt;
&lt;p&gt;Here&apos;s how to appease release_handler if you have a dynamic modules list:¬†&lt;a href=&quot;http://github.com/RJ/mochiweb/commit/931c5fb769be844c307a51596898ca6c55998219&quot;&gt;http://github.com/RJ/mochiweb/commit/931c5fb769be844c307a51596898ca6c55998219&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;In Conclusion&lt;/h2&gt;
&lt;p&gt;In general, this was a rather painful experience.&lt;/p&gt;
&lt;p&gt;What I&apos;d like to be able to do is something like this:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&quot;rebar make_tar newver=&amp;lt;newversion&amp;gt;&quot;&lt;/li&gt;
&lt;li&gt;version in the .app file is automatically incremented for me, modules list is updated. (open $EDITOR for confirmation/additional tweaks)&lt;/li&gt;
&lt;li&gt;Unless I manually wrote it already, .appup is automatically populated with {load_module, Mod} for each module that changed since last version was packaged, opened in $EDITOR so I can tweak/review.&lt;/li&gt;
&lt;li&gt;irccloud-&amp;lt;newver&amp;gt;.tar.gz is created&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Maybe I&apos;ve missed something, and there&apos;s a much easier way to package subsequent releases with rebar, or something else I&apos;ve overlooked.&lt;br /&gt;
How do you package and deploy your Erlang applications to do live-updates?&lt;/p&gt;
</description>
        <pubDate>Sat, 18 Sep 2010 00:00:00 -0500</pubDate>
        <link>http://0.0.0.0:4000/article/erlangotp-releases-rebar-release_handler-appup-etc</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/article/erlangotp-releases-rebar-release_handler-appup-etc</guid>
        
        <category>programming</category>
        
        <category>erlang</category>
        
        <category>hacks</category>
        
        <category>mochiweb</category>
        
        <category>irc</category>
        
        <category>irccloud</category>
        
        <category>otp</category>
        
        <category>appup</category>
        
        <category>sysops</category>
        
        <category>deployment</category>
        
        <category>irccloud</category>
        
        
      </item>
    
      <item>
        <title>Rewriting Playdar: C++ to Erlang, massive savings</title>
        <description>&lt;p&gt;
I&apos;ve heard many anecdotes and claims about how many lines of code are saved when you write in Erlang instead of [C++/other language]. I&apos;m happy to report that I now have first-hand experience and some data to share.
&lt;/p&gt;

&lt;p&gt;
I initially wrote Playdar in C++ (using Boost and Asio libraries), starting back in February this year. I was fortunate to be working with some experienced developers who helped me come to terms with C++. There were three of us hacking on it regularly up until a few months ago, and despite being relatively new to C++, I&apos;ll say that we ended up with a well designed and robust codebase, all things considered.
&lt;/p&gt;

&lt;h2&gt;On Feeling Smug&lt;/h2&gt;

&lt;p&gt;
I&apos;ll admit I felt rather smug making it all work in C++ with Boost and ASIO. Getting it to build on all three platforms and dynamically load extensions (DLLs etc) at runtime in a cross-platform way was also quite satisfying (I had plenty of help with that side of things).  I learned a lot about C++, Boost, ASIO and CMake. But, as the codebase grew, I began to seriously question my decision to use C++. 
&lt;/p&gt;
&lt;p&gt;
My initial reasons for choosing C++ were twofold:
&lt;ul&gt;
&lt;li&gt;Distribution - shipping the Erlang VM didn&apos;t sound like fun&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://developer.kde.org/~wheeler/taglib.html&quot; target=&quot;taglib&quot;&gt;Taglib&lt;/a&gt;  - *the* library to read metadata from audio files (mp3, m4a, ogg etc) is C++&lt;/li&gt;
&lt;/ul&gt;
It turns out Playdar is naturally a good fit for Erlang - it does lots in parallel, and lots of stuff it does is asynchronous  and event based. Even with all the stuff you get with Boost, multithreaded stuff in C++ is inelegant, to put it kindly.
&lt;/p&gt;

&lt;h2&gt;SLOCed and Loaded&lt;/h2&gt;

&lt;p&gt;
Anyway, a couple of weeks ago I sat down to re-implement Playdar from scratch in Erlang. I thrashed out the guts of it in a couple of days, and by the end of the week I almost had it 1:1 features with the C++ codebase. There&apos;s still a bit of C++ left - code to interface with taglib.

Using the SLOCcount tool (SLOC=source lines of code) I counted the lines of code in various modules from both codebases, here are the results:
&lt;br /&gt;
&lt;style type=&quot;text/css&quot;&gt;
#matrix td{ font-size:90%; vertical-align:top; padding: 3px; } #matrix tr { background: #f0f0f0; } #matrix tr.odd { background: #ddd; }
#matrix td.b {font-size:100%; font-weight:bold;}
&lt;/style&gt;
&lt;table id=&quot;matrix&quot; border=&quot;0&quot;&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&quot;b&quot;&gt;&lt;/td&gt;
&lt;td class=&quot;b&quot;&gt;Erlang Version&lt;/td&gt;
&lt;td class=&quot;b&quot;&gt;C++ Version&lt;/td&gt;
&lt;td class=&quot;b&quot;&gt;Savings&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td class=&quot;b&quot;&gt;Core Daemon&lt;/td&gt;
&lt;td&gt;1,100&lt;/td&gt;
&lt;td&gt;4,491&lt;/td&gt;
&lt;td&gt;75%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;b&quot;&gt;Library + Scanner&lt;/td&gt;
&lt;td&gt;197 + 167.cpp&lt;/td&gt;
&lt;td&gt;1,355&lt;/td&gt;
&lt;td&gt;73%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td class=&quot;b&quot;&gt;LAN Resolver&lt;/td&gt;
&lt;td&gt;105&lt;/td&gt;
&lt;td&gt;427&lt;/td&gt;
&lt;td&gt;75%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&quot;b&quot;&gt;P2P&lt;/td&gt;
&lt;td&gt;463&lt;/td&gt;
&lt;td&gt;1,762&lt;/td&gt;
&lt;td&gt;74%&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd b&quot;&gt;
&lt;td class=&quot;b&quot;&gt;TOTAL&lt;/td&gt;
&lt;td&gt;&lt;em&gt;2,032&lt;/em&gt;&lt;/td&gt;
&lt;td&gt;&lt;em&gt;8,035&lt;/em&gt;&lt;/td&gt;
&lt;td&gt;&lt;em&gt;75%&lt;/em&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;strong&gt;
75% less lines of code using Erlang compared to C++ to implement the same thing - not too shabby :)
&lt;/strong&gt;
The second time around writing in Erlang I knew exactly what I was building, so it&apos;s unfair to compare development time of the two codebases, but given how fast I can type I reckon I saved a good few hours of just pounding the keyboard to input the code (and countless hours of debugging: Erlang tends to work first time, really). Well I&apos;m not sure if &quot;saved&quot; is the right word, considering It was working in C++ already, but it&apos;s my time to waste :)
&lt;/p&gt;
&lt;p&gt;
If you count the third party code bundled with both codebases (excluding boost/asio!) then the erlang codebase saves a whopping 92%. I&apos;m more interested in the savings in code I had to write, however.
&lt;/p&gt;
&lt;h2&gt;Memory and CPU Usage&lt;/h2&gt;

&lt;p&gt;
I&apos;ve done some preliminary comparisons between both projects, when it comes to CPU and memory usage both projects are pretty similar. The Erlang codebase uses slightly more memory than C++ at the moment, but I&apos;m convinced I can get that down to at least as low as the C++ project was. I picked up a few optimization tricks from my three-part &lt;a href=&quot;http://www.metabrew.com/article/a-million-user-comet-application-with-mochiweb-part-1/&quot;&gt;Million-user comet experiment&lt;/a&gt; in Erlang earlier this year. I&apos;ll post more about this if I learn any new tricks.
&lt;/p&gt;
&lt;p&gt;
One thing I&apos;ve realised about the Erlang codebase is that I&apos;ve used processes to encapsulate state (active queries, specifically)  where I didn&apos;t really need to. It seemed sensible at the time, but it&apos;s probably just a waste of memory. I&apos;m going to change it to spawn processes to get the work done (ie, a process that runs the query) but not necessarily just to maintain state.
&lt;/p&gt;

&lt;h2&gt;Distribution to the desktop&lt;/h2&gt;

&lt;h3&gt;C++&lt;/h3&gt;
&lt;p&gt;
You just have to make sure that you build everything and ship with any DLLs along with checks in the installer for system libraries needed (runtime dlls). Oh, and make sure you don&apos;t change the plugin binary interface in the main app, or new plugins will crash and burn when you load them. Add a check for that. Oh and be careful about compiling taglib and stuff with mingw and the rest with VC++, or things might mysteriously crash. Also I heard a horror story about allocating memory in plugin code but deallocating it in the main app when the plugin was compiled against a different stdlib than the main app. This is all par for the course, and the experienced C++ developers I asked for help had no trouble making it work. &lt;strong&gt;Size of installable pacakge: 2.5MB&lt;/strong&gt;
&lt;/p&gt;
&lt;h3&gt;Erlang&lt;/h3&gt;
&lt;p&gt;
Compiling, and building/loading plugins in the Erlang codebase is straightforward on all platforms, as is often the way with VMs. I was against shipping the Erlang VM originally because I figured it would be a lot of hassle and increase the download size substantially. Packaging an Erlang app for the desktop involves taking the installed VM directory structure and stripping out all the docs, source and parts of the Erlang stdlib we don&apos;t use, then packaging it along with the compiled Playdar code. &lt;a href=&quot;http://couchdb.apache.org/&quot; target=&quot;cdb&quot;&gt;CouchDB&lt;/a&gt; does something like this too, and &lt;a href=&quot;http://www.rabbitmq.com/&quot; target=&quot;rabbit&quot;&gt;RabbitMQ&lt;/a&gt; ships the Erlang VM without stripping unneeded libs. We&apos;ll work on packaging some more (for all platforms), but to date &lt;a href=&quot;http://twitter.com/mxcl&quot;&gt;Max&lt;/a&gt; has crafted a package that contains the necessary bits of the Erlang VM, a sexy Prefpane to start/stop the daemon on OS X, and the compiled Playdar code all &lt;strong&gt;weighing in under 10MB.&lt;/strong&gt;
&lt;/p&gt;
&lt;p&gt;
We&apos;ll put together a Windows installer soon that&apos;ll probably be around the same size. A 10MB download isn&apos;t so bad nowadays, and I expect we can optimize the packaging process some more. Linux users will get a package that depends on the erlang VM in their package manager.
Seems like shipping Erlang apps to the desktop isn&apos;t so hard after all.
&lt;/p&gt;
&lt;h2&gt;tl;dr&lt;/h2&gt;
&lt;p&gt;
Someone rewrote a C++ app in Erlang: 75% less lines of code for same functionality.
&lt;/p&gt;
&lt;p&gt;
You should read this &lt;a href=&quot;http://musicmachinery.com/2009/10/18/playing-with-playdar/&quot;&gt;blog post about Playdar, by Paul Lamere&lt;/a&gt;,  and take a look at the &lt;a href=&quot;http://www.playdar.org/&quot;&gt;Playdar website&lt;/a&gt;.
&lt;/p&gt;
&lt;p&gt;
&lt;a href=&quot;http://github.com/RJ/playdar&quot;&gt;C++ codebase (deprecated)&lt;/a&gt;
&lt;a href=&quot;http://github.com/RJ/playdar-core&quot;&gt;Erlang codebase&lt;/a&gt;
&lt;/p&gt;
&lt;p&gt;
&lt;strong&gt;Playdar is the future, and the future is written in Erlang :)&lt;/strong&gt;
&lt;/p&gt;
</description>
        <pubDate>Wed, 21 Oct 2009 00:00:00 -0500</pubDate>
        <link>http://0.0.0.0:4000/article/rewriting-playdar-c-to-erlang-massive-savings</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/article/rewriting-playdar-c-to-erlang-massive-savings</guid>
        
        <category>programming</category>
        
        <category>erlang</category>
        
        <category>c</category>
        
        <category>playdar</category>
        
        <category>rewrite</category>
        
        
      </item>
    
      <item>
        <title>Erlang talk at London Hackspace</title>
        <description>&lt;p&gt;Last night I gave an ‚ÄúIntro to Erlang‚Äù talk at a London Hackspace meetup. I did a quick audience survey first: About 75% did ‚Äúweb programming‚Äù (ruby,python,php,etc).¬† Around 30% admitted to regularly using C/C++/Java or desktop/mobile app development.¬† Less than 10% had much experience with functional programming.&lt;/p&gt;

&lt;p&gt;I wanted to impress upon the audience that Erlang is a practical language, built by Ericsson with a specific purpose in mind. You use Erlang to build useful, scalable and reliable distributed systems in the real world. This was worth pointing out because when many people hear ‚Äúfunctional programming‚Äù they immediately think of eccentric bearded academics proving the validity of their Haskell code and comparing Monads.&lt;/p&gt;

&lt;p&gt;I skipped through the basics of sequential programming in Erlang pretty quickly and tried to spend most of the time showing how you handle processes and send messages. I built a basic Erlang server process that kept a count of how many operations it had done, explaining how it passes state to itself on every loop. Hopefully this helped some people grok how you can build servers that keep a global state by using recursion. I also showed off hot code reloading. We added another feature to the server and upgraded it without stopping it.&lt;/p&gt;

&lt;p&gt;You can download the code I used (see link at the end) if you want to try out the examples from last night yourself. The last code I showed was an example of doing the same thing using gen_server, so hopefully if you followed along you‚Äôll have a good understanding of what gen_server is and why it exists.&lt;/p&gt;
&lt;h2&gt;Hot code reloading example&lt;/h2&gt;
&lt;p&gt;I can‚Äôt write a post about Erlang without including some code, so here‚Äôs the basic example I used showing how hot code reloading works:&lt;/p&gt;

&lt;div class=&quot;language-erlang highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;ni&quot;&gt;module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ex09&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;ni&quot;&gt;export&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]).&lt;/span&gt;

&lt;span class=&quot;nf&quot;&gt;start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;spawn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;MODULE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]).&lt;/span&gt;

&lt;span class=&quot;nf&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Ops&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Wtfs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
 &lt;span class=&quot;k&quot;&gt;receive&lt;/span&gt;
   &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;double&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Num&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
     &lt;span class=&quot;nv&quot;&gt;Client&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Num&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
     &lt;span class=&quot;nf&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Ops&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Wtfs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

   &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;square&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Num&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
     &lt;span class=&quot;nv&quot;&gt;Client&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Num&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Num&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
     &lt;span class=&quot;nf&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Ops&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Wtfs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

   &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;_,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Num&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
     &lt;span class=&quot;nv&quot;&gt;Client&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wtf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
     &lt;span class=&quot;nf&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Ops&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Wtfs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

   &lt;span class=&quot;n&quot;&gt;reload&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
     &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Reloading&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
     &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;MODULE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Ops&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Wtfs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

   &lt;span class=&quot;n&quot;&gt;stats&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
     &lt;span class=&quot;nn&quot;&gt;io&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;format&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Ops: &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~p&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;, Wtfs: &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~p&lt;/span&gt;&lt;span class=&quot;s&quot;&gt; &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;~n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Ops&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Wtfs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]),&lt;/span&gt;
     &lt;span class=&quot;nf&quot;&gt;loop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Ops&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Wtfs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
 &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;

&lt;span class=&quot;c&quot;&gt;% basic client API:
&lt;/span&gt;
&lt;span class=&quot;nf&quot;&gt;client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;Pid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Cmd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Num&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;
 &lt;span class=&quot;nv&quot;&gt;Pid&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Cmd&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Num&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
 &lt;span class=&quot;k&quot;&gt;receive&lt;/span&gt;
   &lt;span class=&quot;nv&quot;&gt;Ans&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;Ans&lt;/span&gt;
 &lt;span class=&quot;k&quot;&gt;after&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1000&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;timeout&lt;/span&gt;
 &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And if you were following along you saw something like this:&lt;/p&gt;
&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;1&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;c&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ex09&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;{ok,ex09}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;erl&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;Pid &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; ex09:start&lt;span class=&quot;o&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;&amp;lt;0.38.0&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;3&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;Pid &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; stats.
&lt;span class=&quot;go&quot;&gt;Ops: 0, Wtfs: 0
stats
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;4&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ex09:client&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Pid, double, 10&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;20
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;5&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ex09:client&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Pid, triple, 10&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;wtf
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At this point we added support for ‚Äútriple‚Äù to the example and showed how the fully-qualified call to loop (using the modulename:fun() instead of fun() syntax) causes the newest version of the module to be used:&lt;/p&gt;

&lt;div class=&quot;language-console highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;6&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;c&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;ex09&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;{ok,ex09}
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;7&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ex09:client&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Pid, triple, 10&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;wtf
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;8&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;Pid &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; reload.
&lt;span class=&quot;go&quot;&gt;Reloading
reload
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;9&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;ex09:client&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Pid, triple, 10&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;go&quot;&gt;30
&lt;/span&gt;&lt;span class=&quot;gp&quot;&gt;10&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;Pid &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt; stats.
&lt;span class=&quot;go&quot;&gt;Ops: 2, Wtfs: 2
stats
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can see from the stats at the end that the global state was kept - the server process staying running during the code upgrade.&lt;/p&gt;

&lt;h2&gt;Download&lt;/h2&gt;
&lt;p&gt;The slides, example code and basic mochiweb comet project we saw last night can be downloaded &lt;a title=&quot;Slides and example code&quot; href=&quot;http://www.metabrew.com/misc/erlang-hackspace-talk.tar.gz&quot;&gt;here&lt;/a&gt;. I should warn you that unless you saw my talk and the various explanations and disclaimers that went along with the code, it‚Äôs probably not a good place to start or learn from. Have a look at &lt;a href=&quot;http://www.learnyousomeerlang.com/&quot; target=&quot;_blank&quot;&gt;www.learnyousomeerlang.com&lt;/a&gt; or get one of the two excellent Erlang books.&lt;/p&gt;
&lt;h2&gt;London Hackspace&lt;/h2&gt;
&lt;p&gt;If you live in London you should know about this. &lt;a href=&quot;http://russ.garrett.co.uk/&quot; target=&quot;_blank&quot;&gt;Russ&lt;/a&gt; and &lt;a href=&quot;http://jonty.co.uk/&quot; target=&quot;_blank&quot;&gt;Jonty&lt;/a&gt; (who I worked with at Last.fm for years) started &lt;a href=&quot;http://london.hackspace.org.uk/&quot; target=&quot;_blank&quot;&gt;London Hackspace&lt;/a&gt;: ‚Äú&lt;strong&gt;We run a dedicated space for people to learn and build things in London.‚Äù&lt;/strong&gt; There are workshops at hackspace meetups on topics ranging from Arduino and electronics hacking, to iPhone development, to Erlang and beyond. Their unofficial slogan could be ‚ÄúBeer &amp;amp; Hacking‚Äù - it‚Äôs a great place to meet people doing interesting things in London, and to learn new things.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://london.hackspace.org.uk/&quot; target=&quot;_blank&quot;&gt;http://london.hackspace.org.uk/&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;Playdar&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;http://www.playdar.org/&quot; target=&quot;_blank&quot;&gt;Playdar&lt;/a&gt; is my pet project at the moment. I talked about this last night too. I wrote it in C++ using Boost, mainly as an excuse to do something serious in C++. I‚Äôve &lt;a href=&quot;http://twitter.com/metabrew/status/4494402561&quot; target=&quot;_blank&quot;&gt;since seen the error of my masochistic ways&lt;/a&gt; and in the last week I‚Äôve tossed out the 10,000 lines of C++ and rewritten it in Erlang. I‚Äôm not quite finished, but once I have feature parity between the two codebases I‚Äôll write an article comparing the two.¬† As you might expect, the Erlang codebase is far superior in almost every way.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.playdar.org/&quot; target=&quot;_blank&quot;&gt;http://www.playdar.org/&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Thu, 08 Oct 2009 00:00:00 -0500</pubDate>
        <link>http://0.0.0.0:4000/article/erlang-talk-at-london-hackspace</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/article/erlang-talk-at-london-hackspace</guid>
        
        <category>uncategorized</category>
        
        <category>erlang</category>
        
        <category>playdar</category>
        
        <category>london</category>
        
        <category>hackspace</category>
        
        <category>talk</category>
        
        
      </item>
    
      <item>
        <title>Anti-RDBMS: A list of distributed key-value stores</title>
        <description>&lt;p&gt;&lt;em&gt;Please Note: this was written January 2009 - see the comments for updates and additional information. A lot has changed since I wrote this.&lt;/em&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Perhaps you‚Äôre considering using a dedicated key-value or document store instead of a traditional relational database. Reasons for this might include:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;You&apos;re suffering from Cloud-computing Mania.&lt;/li&gt;
	&lt;li&gt;You need an excuse to &apos;get your Erlang on&apos;&lt;/li&gt;
	&lt;li&gt;You heard CouchDB was cool.&lt;/li&gt;
	&lt;li&gt;You hate MySQL, and although PostgreSQL is much better, it still doesn&apos;t have decent replication. There&apos;s no chance you&apos;re buying Oracle licenses.&lt;/li&gt;
	&lt;li&gt;Your data is stored and retrieved mainly by primary key, without complex joins.&lt;/li&gt;
	&lt;li&gt;You have a non-trivial amount of data, and the thought of managing lots of RDBMS shards and replication failure scenarios gives you the fear.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Whatever your reasons, there are a lot of options to chose from. At Last.fm we do a lot of batch computation in Hadoop, then dump it out to other machines where it‚Äôs indexed and served up over HTTP and &lt;a href=&quot;http://developers.facebook.com/thrift/&quot;&gt;Thrift&lt;/a&gt; as an internal service (stuff like ‚Äòmost popular songs in London, UK this week‚Äô etc). Presently we‚Äôre using a home-grown index format which points into large files containing lots of data spanning many keys, similar to the Haystack approach mentioned in &lt;a href=&quot;http://perspectives.mvdirona.com/2008/06/30/FacebookNeedleInAHaystackEfficientStorageOfBillionsOfPhotos.aspx&quot;&gt;this article about Facebook photo storage&lt;/a&gt;. It works, but rather than build our own replication and partitioning system on top of this, we are looking to potentially replace it with a distributed, resilient key-value store for reasons 4, 5 and 6 above.&lt;/p&gt;

&lt;p&gt;This article represents my notes and research to date on distributed key-value stores (and some other stuff) that might be suitable as RDBMS replacements under the right conditions. I‚Äôm expecting to try some of these out and investigate further in the coming months.&lt;/p&gt;

&lt;h4 id=&quot;glossary-and-background-reading&quot;&gt;Glossary and Background Reading&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;
 &lt;a href=&quot;http://en.wikipedia.org/wiki/Distributed_hash_table&quot;&gt;Distributed Hash Table (DHT)&lt;/a&gt; 
 and algorithms such as Chord or Kadmelia
&lt;/li&gt;

&lt;li&gt;
  &lt;a href=&quot;http://www.allthingsdistributed.com/2007/10/amazons_dynamo.html&quot;&gt;Amazon&apos;s Dynamo Paper&lt;/a&gt;, 
  and &lt;a href=&quot;http://www.readwriteweb.com/archives/amazon_dynamo.php&quot;&gt;this ReadWriteWeb article about Dynamo&lt;/a&gt; which explains why such a system is invaluable
&lt;/li&gt;

&lt;li&gt;
    &lt;a href=&quot;http://aws.amazon.com/simpledb/&quot;&gt;Amazon&apos;s SimpleDB Service&lt;/a&gt;, 
    and &lt;a href=&quot;http://gigaom.com/2007/12/14/amazon-simple-db/&quot;&gt;some&lt;/a&gt;
    &lt;a href=&quot;http://www.satine.org/archives/2007/12/13/amazon-simpledb/&quot;&gt;commentary&lt;/a&gt;
&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://labs.google.com/papers/bigtable.html&quot;&gt;Google&apos;s BigTable paper&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://en.wikipedia.org/wiki/Paxos_algorithm&quot;&gt;The Paxos Algorithm&lt;/a&gt; - read this page in order to appreciate that knocking up a Paxos implementation isn&apos;t something you&apos;d want to do whilst hungover on a Saturday morning.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;the-shortlist&quot;&gt;The Shortlist&lt;/h3&gt;
&lt;p&gt;Here is a list of projects that could potentially replace a group of relational database shards. Some of these are much more than key-value stores, and aren‚Äôt suitable for low-latency data serving, but are interesting none-the-less.&lt;/p&gt;

&lt;style type=&quot;text/css&quot;&gt;
#matrix td{ font-size:90%; vertical-align:top; padding: 3px; } #matrix tr { background: #f0f0f0; } #matrix tr.odd { background: #ddd; } 
#matrix td.bigger {font-size:100%;}
&lt;/style&gt;

&lt;table id=&quot;matrix&quot; border=&quot;0&quot;&gt;
&lt;tbody&gt;
&lt;tr class=&quot;odd&quot; style=&quot;font-weight:bold;&quot;&gt;
&lt;td class=&quot;bigger&quot;&gt;Name&lt;/td&gt;
&lt;td&gt;Language&lt;/td&gt;
&lt;td&gt;Fault-tolerance&lt;/td&gt;
&lt;td&gt;Persistence&lt;/td&gt;
&lt;td&gt;Client Protocol&lt;/td&gt;
&lt;td&gt;Data model&lt;/td&gt;
&lt;td&gt;Docs&lt;/td&gt;
&lt;td&gt;Community&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;font-weight:bold&quot; class=&quot;bigger&quot;&gt;&lt;a class=&quot;external text&quot; title=&quot;http://project-voldemort.com/&quot; href=&quot;http://project-voldemort.com/&quot;&gt;Project Voldemort&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;Java&lt;/td&gt;
&lt;td&gt;partitioned, replicated, read-repair&lt;/td&gt;
&lt;td&gt;Pluggable: BerkleyDB, Mysql&lt;/td&gt;
&lt;td&gt;Java API&lt;/td&gt;
&lt;td&gt;Structured / blob / text&lt;/td&gt;
&lt;td&gt;A&lt;/td&gt;
&lt;td&gt;Linkedin, no&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;font-weight:bold&quot; class=&quot;bigger&quot;&gt;&lt;a class=&quot;external text&quot; title=&quot;http://github.com/tuulos/ringo/tree/master&quot; href=&quot;http://github.com/tuulos/ringo/tree/master&quot;&gt;Ringo&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;Erlang&lt;/td&gt;
&lt;td&gt;partitioned, replicated, immutable&lt;/td&gt;
&lt;td&gt;Custom on-disk (append only log)&lt;/td&gt;
&lt;td&gt;HTTP&lt;/td&gt;
&lt;td&gt;blob&lt;/td&gt;
&lt;td&gt;B&lt;/td&gt;
&lt;td&gt;Nokia, no&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;font-weight:bold&quot; class=&quot;bigger&quot;&gt;&lt;a class=&quot;external text&quot; title=&quot;http://code.google.com/p/scalaris/&quot; href=&quot;http://code.google.com/p/scalaris/&quot;&gt;Scalaris&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;Erlang&lt;/td&gt;
&lt;td&gt;partitioned, replicated, paxos&lt;/td&gt;
&lt;td&gt;In-memory only&lt;/td&gt;
&lt;td&gt;Erlang, Java, HTTP&lt;/td&gt;
&lt;td&gt;blob&lt;/td&gt;
&lt;td&gt;B&lt;/td&gt;
&lt;td&gt;OnScale, no&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;font-weight:bold&quot; class=&quot;bigger&quot;&gt;&lt;a class=&quot;external text&quot; title=&quot;http://kai.wiki.sourceforge.net/&quot; href=&quot;http://kai.wiki.sourceforge.net/&quot;&gt;Kai&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;Erlang&lt;/td&gt;
&lt;td&gt;partitioned, replicated?&lt;/td&gt;
&lt;td&gt;On-disk Dets file&lt;/td&gt;
&lt;td&gt;Memcached&lt;/td&gt;
&lt;td&gt;blob&lt;/td&gt;
&lt;td&gt;C&lt;/td&gt;
&lt;td&gt;no&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;font-weight:bold&quot; class=&quot;bigger&quot;&gt;&lt;a class=&quot;external text&quot; title=&quot;http://github.com/cliffmoon/dynomite/tree/master&quot; href=&quot;http://github.com/cliffmoon/dynomite/tree/master&quot;&gt;Dynomite&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;Erlang&lt;/td&gt;
&lt;td&gt;partitioned, replicated&lt;/td&gt;
&lt;td&gt;Pluggable: couch, dets&lt;/td&gt;
&lt;td&gt;Custom ascii, Thrift&lt;/td&gt;
&lt;td&gt;blob&lt;/td&gt;
&lt;td&gt;D+&lt;/td&gt;
&lt;td&gt;Powerset, no&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;font-weight:bold&quot; class=&quot;bigger&quot;&gt;&lt;a class=&quot;external text&quot; title=&quot;http://memcachedb.org/&quot; href=&quot;http://memcachedb.org/&quot;&gt;MemcacheDB&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;C&lt;/td&gt;
&lt;td&gt;replication&lt;/td&gt;
&lt;td&gt;BerkleyDB&lt;/td&gt;
&lt;td&gt;Memcached&lt;/td&gt;
&lt;td&gt;blob&lt;/td&gt;
&lt;td&gt;B&lt;/td&gt;
&lt;td&gt;some&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;font-weight:bold&quot; class=&quot;bigger&quot;&gt;&lt;a class=&quot;external text&quot; title=&quot;http://code.google.com/p/thrudb/&quot; href=&quot;http://code.google.com/p/thrudb/&quot;&gt;ThruDB&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;C++&lt;/td&gt;
&lt;td&gt;Replication&lt;/td&gt;
&lt;td&gt;Pluggable: BerkleyDB, Custom, Mysql, S3&lt;/td&gt;
&lt;td&gt;Thrift&lt;/td&gt;
&lt;td&gt;Document oriented&lt;/td&gt;
&lt;td&gt;C+&lt;/td&gt;
&lt;td&gt;Third rail, unsure&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;font-weight:bold&quot; class=&quot;bigger&quot;&gt;&lt;a class=&quot;external text&quot; title=&quot;http://couchdb.apache.org/&quot; href=&quot;http://couchdb.apache.org/&quot;&gt;CouchDB&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;Erlang&lt;/td&gt;
&lt;td&gt;Replication, partitioning?&lt;/td&gt;
&lt;td&gt;Custom on-disk&lt;/td&gt;
&lt;td&gt;HTTP, json&lt;/td&gt;
&lt;td&gt;Document oriented (json)&lt;/td&gt;
&lt;td&gt;A&lt;/td&gt;
&lt;td&gt;Apache, yes&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;font-weight:bold&quot; class=&quot;bigger&quot;&gt;&lt;a class=&quot;external text&quot; title=&quot;http://code.google.com/p/the-cassandra-project/&quot; href=&quot;http://code.google.com/p/the-cassandra-project/&quot;&gt;Cassandra&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;Java&lt;/td&gt;
&lt;td&gt;Replication, partitioning&lt;/td&gt;
&lt;td&gt;Custom on-disk&lt;/td&gt;
&lt;td&gt;Thrift&lt;/td&gt;
&lt;td&gt;Bigtable meets Dynamo&lt;/td&gt;
&lt;td&gt;F&lt;/td&gt;
&lt;td&gt;Facebook, no&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&quot;odd&quot;&gt;
&lt;td style=&quot;font-weight:bold&quot; class=&quot;bigger&quot;&gt;&lt;a class=&quot;external text&quot; title=&quot;http://hadoop.apache.org/hbase/&quot; href=&quot;http://hadoop.apache.org/hbase/&quot;&gt;HBase&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;Java&lt;/td&gt;
&lt;td&gt;Replication, partitioning&lt;/td&gt;
&lt;td&gt;Custom on-disk&lt;/td&gt;
&lt;td&gt;Custom API, Thrift, Rest&lt;/td&gt;
&lt;td&gt;Bigtable&lt;/td&gt;
&lt;td&gt;A&lt;/td&gt;
&lt;td&gt;Apache, yes&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td style=&quot;font-weight:bold&quot; class=&quot;bigger&quot;&gt;&lt;a class=&quot;external text&quot; title=&quot;http://hypertable.org/&quot; href=&quot;http://hypertable.org/&quot;&gt;Hypertable&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;C++&lt;/td&gt;
&lt;td&gt;Replication, partitioning&lt;/td&gt;
&lt;td&gt;Custom on-disk&lt;/td&gt;
&lt;td&gt;Thrift, other&lt;/td&gt;
&lt;td&gt;Bigtable&lt;/td&gt;
&lt;td&gt;A&lt;/td&gt;
&lt;td&gt;Zvents, Baidu, yes&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;p&gt;&lt;br /&gt;&lt;/p&gt;

&lt;h3 id=&quot;why-5-of-these-arent-suitable&quot;&gt;Why 5 of these aren‚Äôt suitable&lt;/h3&gt;

&lt;p&gt;What I‚Äôm really looking for is a low latency, replicated, distributed key-value store. Something that scales well as you feed it more machines, and doesn‚Äôt require much setup or maintenance - it should just work. The API should be that of a simple hashtable: set(key, val), get(key), delete(key). This would dispense with the hassle of managing a sharded / replicated database setup, and hopefully be capable of serving up data by primary key efficiently.&lt;/p&gt;

&lt;p&gt;Five of the projects on the list are far from being simple key-value stores, and as such don‚Äôt meet the requirements - but they are definitely worth a mention.&lt;/p&gt;

&lt;h4 id=&quot;hadoop&quot;&gt;Hadoop&lt;/h4&gt;
&lt;p&gt;We‚Äôre already heavy users of Hadoop, and have been experimenting with Hbase for a while. It‚Äôs much more than a KV store, but latency is too great to serve data to the website. We will probably use Hbase internally for other stuff though - we already have stacks of data in HDFS.&lt;/p&gt;

&lt;h4 id=&quot;hypertable&quot;&gt;Hypertable&lt;/h4&gt;
&lt;p&gt;Hypertable provides a similar feature set to Hbase (both are inspired by Google‚Äôs Bigtable). They recently announced a new sponsor, Baidu - the biggest Chinese search engine. Definitely one to watch, but doesn‚Äôt fit the low-latency KV store bill either.&lt;/p&gt;

&lt;h4 id=&quot;cassandra&quot;&gt;Cassandra&lt;/h4&gt;
&lt;p&gt;Cassandra sounded very promising when the source was released by Facebook last year. They use it for inbox search. It‚Äôs Bigtable-esque, but uses a DHT so doesn‚Äôt need a central server (one of the Cassandra developers previously worked at Amazon on Dynamo). Unfortunately it‚Äôs languished in relative obscurity since release, because Facebook never really seemed interested in it as an open-source project. From what I can tell there isn‚Äôt much in the way of documentation or a community around the project at present.&lt;/p&gt;

&lt;h4 id=&quot;couchdb&quot;&gt;CouchDB&lt;/h4&gt;
&lt;p&gt;CouchDB is an interesting one - it‚Äôs a ‚Äúdistributed, fault-tolerant and schema-free document-oriented database accessible via a RESTful HTTP/JSON API‚Äù. Data is stored in ‚Äòdocuments‚Äô, which are essentially key-value maps themselves, using the data types you see in JSON.  Read the &lt;a href=&quot;http://couchdb.apache.org/docs/overview.html&quot;&gt;CouchDB Technical Overview&lt;/a&gt; if you are curious how the web‚Äôs trendiest document database works under the hood. This article on the &lt;a href=&quot;http://push.cx/2009/rules-of-database-app-aging&quot;&gt;Rules of Database App Aging&lt;/a&gt; goes some way to explaining why document-oriented databases make sense. CouchDB can do full text indexing of your documents, and lets you express views over your data in Javascript. I could imagine using CouchDB to store lots of data on users: name, age, sex, address, IM name and lots of other fields, many of which could be null, and each site update adds or changes the available fields. In situations like that it quickly gets unwieldly adding and changing columns in a database, and updating versions of your application code to match. Although many people are using CouchDB in production, their FAQ points out they may still make backwards-incompatible changes to the storage format and API before version 1.0.&lt;/p&gt;

&lt;h4 id=&quot;thrudb&quot;&gt;ThruDB&lt;/h4&gt;
&lt;p&gt;ThruDB is a document storage and indexing system made up for four components: a document storage service, indexing service, message queue and proxy. It uses Thrift for communication, and has a pluggable storage subsystem, including an Amazon S3 option. It‚Äôs designed to scale well horizontally, and might be a better option that CouchDB if you are running on EC2. I‚Äôve heard a lot more about CouchDB than Thrudb recently, but it‚Äôs definitely worth a look if you need a document database. It‚Äôs not suitable for our needs for the same reasons as CouchDB.&lt;/p&gt;

&lt;h3 id=&quot;distributed-key-value-stores&quot;&gt;Distributed key-value stores&lt;/h3&gt;

&lt;p&gt;The rest are much closer to being ‚Äòsimple‚Äô key-value stores with low enough latency to be used for serving data used to build dynamic pages. Latency will be dependent on the environment, and whether or not the dataset fits in memory. If it does, I‚Äôd expect sub-10ms response time, and if not, it all depends on how much money you spent on spinning rust.&lt;/p&gt;

&lt;h4 id=&quot;memcachedb&quot;&gt;MemcacheDB&lt;/h4&gt;

&lt;p&gt;Essentially just memcached that saves stuff to disk using a Berkeley database. As useful as this may be for some situations, it doesn‚Äôt deal with replication and partitioning (sharding), so it would still require a lot of work to make it scale horizontally and be tolerant of machine failure. Other memcached derivatives such as &lt;a href=&quot;http://repcached.lab.klab.org/&quot;&gt;repcached&lt;/a&gt; go some way to addressing this by giving you the ability to replicate entire memcache servers (async master-slave setup), but without partitioning it‚Äôs still going to be a pain to manage.&lt;/p&gt;

&lt;h4 id=&quot;project-voldemort&quot;&gt;Project Voldemort&lt;/h4&gt;

&lt;p&gt;Looks &lt;em&gt;awesome&lt;/em&gt;. Go and read the &lt;a href=&quot;http://project-voldemort.com/&quot;&gt;rather splendid website&lt;/a&gt;, which explains how it works, and includes pretty diagrams and a good description of how consistent hashing is used in the Design section. (If consistent hashing butters your muffin, check out &lt;a href=&quot;http://www.last.fm/user/RJ/journal/2007/04/10/rz_libketama_-_a_consistent_hashing_algo_for_memcache_clients&quot;&gt;libketama - a consistent hashing library&lt;/a&gt; and the &lt;a href=&quot;http://www.metabrew.com/article/erlang-libketama-driver-consistent-hashing/&quot;&gt;Erlang libketama driver&lt;/a&gt;). Project-Voldemort handles replication and partitioning of data, and appears to be well written and designed. It‚Äôs reassuring to read in the docs how easy it is to swap out and mock different components for testing. It‚Äôs non-trivial to add nodes to a running cluster, but according to the mailing-list this is being worked on. It sounds like this would fit the bill if we ran it with a Java load-balancer service (see their Physical Architecture Options diagram) that exposed a Thrift API so all our non-Java clients could use it.&lt;/p&gt;

&lt;h4 id=&quot;scalaris&quot;&gt;Scalaris&lt;/h4&gt;

&lt;p&gt;Probably the most face-meltingly awesome thing you could build in Erlang. CouchDB, Ejabberd and RabbitMQ are cool, but Scalaris packs by far the most impressive collection of sexy technologies. Scalaris is a key-value store - it uses a modified version of the Chord algorithm to form a DHT, and stores the keys in lexicographical order, so range queries are possible. Although I didn‚Äôt see this explicitly mentioned, this should open up all sorts of interesting options for batch processing - map-reduce for example.  On top of the DHT they use an improved version of &lt;a href=&quot;http://en.wikipedia.org/wiki/Paxos_algorithm&quot;&gt;Paxos&lt;/a&gt; to guarantee ACID properties when dealing with multiple concurrent transactions. So it‚Äôs a key-value store, but it can guarantee the ACID properties and do proper distributed transactions over multiple keys.&lt;/p&gt;

&lt;p&gt;Oh, and to demonstrate how you can scale a webservice based on such a system, the Scalaris folk implemented their own version of Wikipedia on Scalaris, loaded in the Wikipedia data, and benchmarked their setup to prove it can do more transactions/sec on equal hardware than the classic PHP/MySQL combo that Wikipedia use. Yikes.&lt;/p&gt;

&lt;p&gt;From what I can tell, Scalaris is only memory-resident at the moment and doesn‚Äôt persist data to disk. This makes it entirely impractical to actually run a service like Wikipedia on Scalaris for real - but it sounds like they tackled the hard problems first, and persisting to disk should be a walk in the park after you rolled your own version of Chord and made Paxos your bitch. Take a look at this presentation about Scalaris from the Erlang Exchange conference: &lt;a href=&quot;http://video.google.com/videoplay?docid=6981137233069932108&amp;amp;ei=caB0SaPUNIW0iALk-9CMBQ&quot;&gt;
    Scalaris presentation video
  &lt;/a&gt;&lt;/p&gt;

&lt;h4 id=&quot;the-rest&quot;&gt;The Rest&lt;/h4&gt;

&lt;p&gt;The reminaing projects, &lt;em&gt;Dynomite&lt;/em&gt;, &lt;em&gt;Ringo&lt;/em&gt; and &lt;em&gt;Ka&lt;/em&gt; are all, more or less, trying to be Dynamo. Of the three, &lt;em&gt;Ringo&lt;/em&gt; looks to be the most specialist - it makes a distinction between small (less than 4KB) and medium-size data items (&amp;lt;100MB). Medium sized items are stored in individual files, whereas small items are all stored in an append-log, the index of which is read into memory at startup. From what I can tell, Ringo can be used in conjunction with the Erlang map-reduce framework Nokia are working on called &lt;a href=&quot;http://discoproject.org&quot;&gt;Disco&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I didn‚Äôt find out much about &lt;em&gt;Kai&lt;/em&gt; other than it‚Äôs rather new, and some mentions in Japanese. You can chose either Erlang ets or dets as the storage system (memory or disk, respectively), and it uses the memcached protocol, so it will already have client libraries in many languages.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Dynomite&lt;/em&gt; doesn‚Äôt have great documentation, but it seems to be more capable than Kai, and is under active development. It has pluggable backends including the storage mechanism from CouchDB, so the 2GB file limit in dets won‚Äôt be an issue. Also I heard that Powerset are using it, so that‚Äôs encouraging.&lt;/p&gt;

&lt;h3 id=&quot;summary&quot;&gt;Summary&lt;/h3&gt;

&lt;p&gt;Scalaris is fascinating, and I hope I can find the time to experiment more with it, but it needs to save stuff to disk before it‚Äôd be useful for the kind of things we might use it for at Last.fm.&lt;/p&gt;

&lt;p&gt;I‚Äôm keeping an eye on Dynomite - hopefully more information will surface about what Powerset are doing with it, and how it performs at a large scale.&lt;/p&gt;

&lt;p&gt;Based on my research so far, Project-Voldemort looks like the most suitable for our needs. I‚Äôd love to hear more about how it‚Äôs used at LinkedIn, and how many nodes they are running it on.&lt;/p&gt;

&lt;h3 id=&quot;what-else-is-there&quot;&gt;What else is there?&lt;/h3&gt;

&lt;p&gt;Here are some other related projects:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;http://www.hazelcast.com/&quot;&gt;Hazelcast&lt;/a&gt; - Java DHT/clustering library&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://blitiri.com.ar/p/nmdb/&quot;&gt;nmdb&lt;/a&gt; - a network database (dbm-style)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://open-chord.sourceforge.net/&quot;&gt;Open Chord&lt;/a&gt; - Java DHT&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If you know of anything I‚Äôve missed off the list, or have any feedback/suggestions, please post a comment. I‚Äôm especially interested in hearing about people who‚Äôve tested or are using KV-stores in lieu of relational databases.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;UPDATE 1:&lt;/em&gt; Corrected table: memcachedb does replication, as per BerkeleyDB.&lt;/p&gt;
</description>
        <pubDate>Mon, 19 Jan 2009 00:00:00 -0600</pubDate>
        <link>http://0.0.0.0:4000/article/anti-rdbms-a-list-of-distributed-key-value-stores</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/article/anti-rdbms-a-list-of-distributed-key-value-stores</guid>
        
        <category>programming</category>
        
        <category>erlang</category>
        
        <category>hashing</category>
        
        <category>java</category>
        
        <category>databases</category>
        
        <category>dht</category>
        
        <category>nosql</category>
        
        
      </item>
    
      <item>
        <title>How we use IRC at Last.fm</title>
        <description>&lt;p&gt;Everyone that works at Last.fm is typically connected to our IRC server. We have different channels per team, as well as a company-wide channel, and a few channels dedicated to automated monitoring.&lt;/p&gt;

&lt;p&gt;Sometimes it makes much more sense to discuss / ask questions on IRC instead of email, and it‚Äôs useful to be able to raise people who are not in the office. That said, the main reason I‚Äôm writing this post is to mention the dev-support bot we use: irccat.&lt;/p&gt;

&lt;h3 id=&quot;irccat---development-support-bot&quot;&gt;IRCCat - Development support bot&lt;/h3&gt;

&lt;p&gt;The irccat bot joins all your channels, and waits for messages on a specified ip:port on your internal network. Anything you send to that port will be sent to IRC by the bot. IRCCat - as in, &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cat&lt;/code&gt; to IRC.&lt;/p&gt;

&lt;p&gt;Using netcat, you can easily send events to irc from shell scripts:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Something just happened&quot;&lt;/span&gt; | nc &lt;span class=&quot;nt&quot;&gt;-q0&lt;/span&gt; somemachine 12345
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That will send to the default channel only (first in the config file). You can direct messages to specific combinations of channels (#) or users (@) like so:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#syschan Starting backup job&quot;&lt;/span&gt; | nc &lt;span class=&quot;nt&quot;&gt;-q0&lt;/span&gt; somemachine 12345
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;or:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;#musicteam,#legal,@alice New album uploaded: ...&quot;&lt;/span&gt; | nc &lt;span class=&quot;nt&quot;&gt;-q0&lt;/span&gt; somemachine 12345
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Some of the things we automatically send to appropriate IRC channels:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;SVN commits&lt;/li&gt;
	&lt;li&gt;JIRA issue tracker updates&lt;/li&gt;
	&lt;li&gt;Nagios alerts for monitored hosts and services&lt;/li&gt;
	&lt;li&gt;Deployment notices to testing/staging/production&lt;/li&gt;
	&lt;li&gt;Results of automated tests if something bad happens&lt;/li&gt;
	&lt;li&gt;Links to pics from security camfeed when someone opens the office door out of hours&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We also post messages from automated backup jobs etc, which helps correlate such events with any unusual load spikes or glitches in usually-smooth graphs.&lt;/p&gt;

&lt;p&gt;In addition to providing a cat-to-irc conduit, irccat will also hand off commands to a script you can provide. We use this to expose lookup tools and some admin functions to our support staff and developers. The handler script we use is PHP, and has access to our core website libs. Typing ‚Äú?pokereleasenode‚Äù, ‚Äú?lookup user RJ‚Äù or ‚Äú?uncache artist Radiohead‚Äù is faster than writing a throw-away script, more accessible to non-developers, less hassle than a web interface and creates a public log so people can see what‚Äôs going on.&lt;/p&gt;

&lt;p&gt;The bot is written in Java, it‚Äôs easy to build and configure, all the deps are included:&lt;/p&gt;

&lt;p&gt;&lt;a title=&quot;IRCcat source on GitHub&quot; href=&quot;http://github.com/RJ/irccat/tree/master&quot; target=&quot;_blank&quot;&gt;http://github.com/RJ/irccat/tree/master&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Thu, 08 Jan 2009 00:00:00 -0600</pubDate>
        <link>http://0.0.0.0:4000/article/how-we-use-irc-at-lastfm</link>
        <guid isPermaLink="true">http://0.0.0.0:4000/article/how-we-use-irc-at-lastfm</guid>
        
        <category>programming</category>
        
        <category>lastfm</category>
        
        <category>irc</category>
        
        <category>java</category>
        
        
      </item>
    
  </channel>
</rss>
